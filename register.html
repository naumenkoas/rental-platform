<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Rental Platform - Register</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-100 min-h-screen flex items-center justify-center">
  <div class="bg-white p-8 rounded-2xl shadow-lg max-w-sm w-full">
    <div class="text-center mb-6">
      <h1 class="text-2xl font-bold text-slate-800">Create Account</h1>
      <p class="text-slate-500 text-sm">Join us as a Landlord or Tenant</p>
    </div>

    <div class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
        <input id="email" type="email" placeholder="you@example.com"
          class="w-full px-3 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500" />
      </div>
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-1">Password</label>
        <input id="password" type="password" placeholder="Create a password"
          class="w-full px-3 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500" />
      </div>
      
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-2">I am a:</label>
        <div class="grid grid-cols-2 gap-3">
          <label class="cursor-pointer">
            <input type="radio" name="role" value="tenant" class="peer sr-only" checked />
            <div class="text-center py-2 border rounded-xl peer-checked:bg-emerald-600 peer-checked:text-white peer-checked:border-emerald-600 hover:bg-slate-50 transition">
              Tenant
            </div>
          </label>
          <label class="cursor-pointer">
            <input type="radio" name="role" value="landlord" class="peer sr-only" />
            <div class="text-center py-2 border rounded-xl peer-checked:bg-emerald-600 peer-checked:text-white peer-checked:border-emerald-600 hover:bg-slate-50 transition">
              Landlord
            </div>
          </label>
        </div>
      </div>

      <p id="errorMsg" class="text-red-600 text-sm text-center hidden"></p>
      <p id="successMsg" class="text-emerald-600 text-sm text-center hidden"></p>

      <button id="registerBtn"
        class="w-full py-2 rounded-xl bg-emerald-600 text-white font-semibold hover:bg-emerald-700 transition">
        Sign Up
      </button>

      <div class="text-center text-sm text-slate-600 mt-4">
        Already have an account? 
        <a href="index.html" class="text-emerald-600 font-semibold hover:underline">Sign in</a>
      </div>
    </div>
  </div>

<script>
  const supabaseUrl = "https://zzkriumjamchjrxdxhzf.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp6a3JpdW1qYW1jaGpyeGR4aHpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNDkyNDcsImV4cCI6MjA3OTgyNTI0N30.mK7jN6En9SWhr2Avt545CIGm58Kd7ACgs8hGOe4UKMU";
  const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

  const registerBtn = document.getElementById("registerBtn");
  const errorMsg = document.getElementById("errorMsg");
  const successMsg = document.getElementById("successMsg");

  registerBtn.addEventListener("click", async () => {
    errorMsg.classList.add("hidden");
    successMsg.classList.add("hidden");
    registerBtn.disabled = true;
    registerBtn.textContent = "Creating account...";

    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value.trim();
    const roleEl = document.querySelector('input[name="role"]:checked');
    const role = roleEl ? roleEl.value : "tenant";

    if (!email || !password) {
      showError("Please fill in all fields.");
      resetBtn();
      return;
    }

    // 1. Регистрация пользователя (Sign Up)
    const { data: authData, error: authError } = await supabase.auth.signUp({
      email,
      password
    });

    if (authError) {
      showError(authError.message);
      resetBtn();
      return;
    }

    // Проверяем, создался ли юзер
    if (authData && authData.user) {
      const userId = authData.user.id;

      // 2. Создаем запись в таблице profiles
      const { error: profileError } = await supabase
        .from("profiles")
        .insert([{ id: userId, role: role }]);

      if (profileError) {
        console.error("Profile error", profileError);
        // Даже если профиль не создался, юзер уже есть в Auth. 
        // Но без профиля он не войдет.
        showError("Account created, but profile setup failed. Please contact support.");
        resetBtn();
        return;
      }

      // УСПЕХ
      successMsg.textContent = "Success! Redirecting to login...";
      successMsg.classList.remove("hidden");
      
      // Ждем секунду и перекидываем на вход
      setTimeout(() => {
        window.location.href = "index.html";
      }, 1500);

    } else {
      // Если включено подтверждение email
      showError("Check your email for the confirmation link.");
      resetBtn();
    }
  });

  function showError(text) {
    errorMsg.textContent = text;
    errorMsg.classList.remove("hidden");
  }

  function resetBtn() {
    registerBtn.disabled = false;
    registerBtn.textContent = "Sign Up";
  }
</script>
</body>
</html>
