<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Find your home</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-100 min-h-screen">
  <div class="max-w-6xl mx-auto py-8 px-4">
    <header class="flex justify-between items-center mb-8">
      <div>
        <h1 class="text-3xl font-bold text-slate-800">Find your home</h1>
        <p id="welcomeUser" class="text-slate-500 text-sm">Welcome</p>
      </div>
      <div>
        <a id="dashboardBtn"
           href="landlord.html"
           class="hidden px-4 py-2 text-sm text-emerald-600 font-semibold hover:underline">
          Go to Dashboard
        </a>
        <button id="logoutBtn"
          class="px-4 py-2 rounded-xl bg-slate-800 text-white font-semibold hover:bg-slate-900 transition">
          Log out
        </button>
      </div>
    </header>

    <div class="grid md:grid-cols-4 gap-6">
      <aside class="bg-white p-5 rounded-2xl shadow h-fit">
        <h2 class="font-semibold text-lg mb-4 flex justify-between">
          Filters
          <button id="resetFilters" class="text-xs text-emerald-600 font-normal">
            Reset
          </button>
        </h2>
        <div class="space-y-4">
          <div>
            <label class="text-xs font-bold text-slate-500 uppercase">City</label>
            <input id="filterCity" type="text" placeholder="New York"
                   class="w-full px-3 py-2 border rounded-xl text-sm mt-1" />
          </div>
          <div>
            <label class="text-xs font-bold text-slate-500 uppercase">Max Price</label>
            <input id="filterMaxPrice" type="number" placeholder="Any"
                   class="w-full px-3 py-2 border rounded-xl text-sm mt-1" />
          </div>
          <div class="space-y-2 pt-2 border-t">
            <label class="flex items-center gap-2">
              <input id="filterWifi" type="checkbox">
              <span class="text-sm">Wi-Fi</span>
            </label>
            <label class="flex items-center gap-2">
              <input id="filterPets" type="checkbox">
              <span class="text-sm">Pets</span>
            </label>
            <label class="flex items-center gap-2">
              <input id="filterFurnished" type="checkbox">
              <span class="text-sm">Furnished</span>
            </label>
          </div>
          <button id="applyFiltersBtn"
                  class="w-full py-2 bg-emerald-600 text-white rounded-xl font-semibold mt-2">
            Apply
          </button>
        </div>
      </aside>

      <main class="md:col-span-3">
        <!-- ОСНОВНОЙ СПИСОК ОБЪЯВЛЕНИЙ -->
        <div id="listingsContainer"
             class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
          <p class="text-slate-500">Loading...</p>
        </div>

        <!-- ИЗБРАННЫЕ ОБЪЯВЛЕНИЯ -->
        <section id="favoritesSection" class="mt-8 hidden">
          <h2 class="font-semibold text-lg mb-3">My favorite listings</h2>
          <div id="favoritesList"
               class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4 text-sm text-slate-700">
          </div>
        </section>

        <!-- СПИСОК ДИАЛОГОВ АРЕНДАТОРА -->
        <section id="conversationsSection" class="mt-8 hidden">
          <h2 class="font-semibold text-lg mb-3">My conversations with landlords</h2>
          <div id="conversationsList"
               class="space-y-3 text-sm text-slate-700">
          </div>
        </section>
      </main>
    </div>
  </div>

<script>
  const supabaseUrl = "https://zzkriumjamchjrxdxhzf.supabase.co";
  const supabaseKey =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp6a3JpdW1qYW1jaGpyeGR4aHpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNDkyNDcsImV4cCI6MjA3OTgyNTI0N30.mK7jN6En9SWhr2Avt545CIGm58Kd7ACgs8hGOe4UKMU";
  const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

  let currentUser = null;
  let currentRole = null; // "landlord" | "tenant" | null
  let favoritesSet = new Set();

  const favoritesSectionEl = document.getElementById("favoritesSection");
  const favoritesListEl = document.getElementById("favoritesList");
  const conversationsSectionEl = document.getElementById("conversationsSection");
  const conversationsListEl = document.getElementById("conversationsList");

  window.addEventListener("load", async () => {
    const welcomeEl = document.getElementById("welcomeUser");
    const dashboardBtn = document.getElementById("dashboardBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    // 1. Auth check
    const { data, error: authErr } = await supabase.auth.getUser();
    if (!authErr && data && data.user) {
      currentUser = data.user;
      welcomeEl.textContent = `Logged in as ${currentUser.email}`;

      // Профиль и роль
      const { data: profile, error: profErr } = await supabase
        .from("profiles")
        .select("role")
        .eq("id", currentUser.id)
        .maybeSingle();

      if (!profErr && profile && profile.role) {
        currentRole = profile.role;
        if (currentRole === "landlord") {
          dashboardBtn.classList.remove("hidden");
        }
      }
    } else {
      welcomeEl.textContent = "Guest";
    }

    // 2. Logout
    logoutBtn.addEventListener("click", async () => {
      await supabase.auth.signOut();
      window.location.href = "index.html";
    });

    // 3. Filters
    document.getElementById("applyFiltersBtn").onclick = loadListings;
    document.getElementById("resetFilters").onclick = () => {
      document.getElementById("filterCity").value = "";
      document.getElementById("filterMaxPrice").value = "";
      ["filterWifi", "filterPets", "filterFurnished"].forEach(id => {
        document.getElementById(id).checked = false;
      });
      loadListings();
    };

    // 4. Подгружаем favorites и диалоги для арендатора, если залогинен
    if (currentUser) {
      await loadUserFavorites();
      await loadTenantConversations();
    }

    // 5. Основной список
    await loadListings();
    // после основного списка можно обновить секцию избранного (визуальный список)
    if (currentUser) {
      await refreshFavoritesSection();
    }
  });

  // ---------- FAVORITES: ЗАГРУЗКА СПИСКА ДЛЯ ТЕКУЩЕГО ЮЗЕРА ----------

  async function loadUserFavorites() {
    favoritesSet = new Set();
    const { data, error } = await supabase
      .from("favorites")
      .select("listing_id");

    if (error) {
      console.error("loadUserFavorites error", error);
      // не ломаем страницу, просто отключаем функционал
      return;
    }

    if (data && data.length) {
      data.forEach(row => {
        if (row.listing_id != null) {
          favoritesSet.add(row.listing_id);
        }
      });
    }
  }

  async function toggleFavoriteButton(btn) {
    if (!currentUser) {
      alert("Log in to use favorites.");
      return;
    }
    const listingIdStr = btn.getAttribute("data-listing-id");
    if (!listingIdStr) return;

    const listingId = parseInt(listingIdStr, 10);
    const isFav = btn.getAttribute("data-is-favorite") === "true";

    if (!isFav) {
      // добавить в избранное
      const { error } = await supabase
        .from("favorites")
        .insert([{ listing_id: listingId }]);
      if (error) {
        console.error("add favorite error", error);
        alert(error.message || "Failed to add to favorites.");
        return;
      }
      favoritesSet.add(listingId);
    } else {
      // убрать из избранного
      const { data, error } = await supabase
        .from("favorites")
        .select("id")
        .eq("listing_id", listingId)
        .limit(1)
        .maybeSingle();

      if (error) {
        console.error("get favorite error", error);
        alert(error.message || "Failed to remove from favorites.");
        return;
      }
      if (data) {
        const { error: delErr } = await supabase
          .from("favorites")
          .delete()
          .eq("id", data.id);
        if (delErr) {
          console.error("delete favorite error", delErr);
          alert(delErr.message || "Failed to remove from favorites.");
          return;
        }
      }
      favoritesSet.delete(listingId);
    }

    // обновляем кнопку
    const nowFav = favoritesSet.has(listingId);
    btn.setAttribute("data-is-favorite", nowFav ? "true" : "false");
    btn.textContent = nowFav ? "★ In favorites" : "☆ Add to favorites";

    // обновляем секцию списка избранного
    await refreshFavoritesSection();
  }

  async function refreshFavoritesSection() {
    if (!currentUser) {
      favoritesSectionEl.classList.add("hidden");
      return;
    }

    if (!favoritesSet.size) {
      favoritesSectionEl.classList.add("hidden");
      favoritesListEl.innerHTML =
        '<p class="text-slate-500 text-sm">No favorite listings yet.</p>';
      return;
    }

    const ids = Array.from(favoritesSet);
    const { data, error } = await supabase
      .from("listing")
      .select("*")
      .in("id", ids)
      .order("created_at", { ascending: false });

    if (error) {
      console.error("refreshFavoritesSection error", error);
      favoritesSectionEl.classList.add("hidden");
      return;
    }

    favoritesSectionEl.classList.remove("hidden");
    favoritesListEl.innerHTML = "";

    if (!data || !data.length) {
      favoritesListEl.innerHTML =
        '<p class="text-slate-500 text-sm">No favorite listings yet.</p>';
      return;
    }

    data.forEach(item => {
      const card = document.createElement("div");
      card.className =
        "bg-white rounded-2xl shadow hover:shadow-md transition overflow-hidden";

      const imgUrl = item.main_photo_url || "https://via.placeholder.com/400x300";

      card.innerHTML = `
        <div class="h-32 overflow-hidden bg-slate-200">
          <img src="${imgUrl}" class="w-full h-full object-cover">
        </div>
        <div class="p-3">
          <div class="flex justify-between items-center mb-1">
            <h3 class="font-semibold text-sm text-slate-800 truncate">${item.title || "(no title)"}</h3>
            <span class="text-xs text-emerald-700 font-semibold">
              ${item.price_per_month != null ? "$" + item.price_per_month + "/mo" : ""}
            </span>
          </div>
          <p class="text-xs text-slate-500 mb-2">${item.city || ""}</p>
          <button class="w-full py-1.5 rounded-xl border border-emerald-600 text-emerald-600 text-xs font-semibold hover:bg-emerald-50">
            Open listing
          </button>
        </div>
      `;

      const btn = card.querySelector("button");
      btn.addEventListener("click", () => {
        window.location.href = `listing-details.html?id=${item.id}`;
      });

      favoritesListEl.appendChild(card);
    });
  }

  // ---------- СПИСОК ДИАЛОГОВ АРЕНДАТОРА ----------

  async function loadTenantConversations() {
    // только для role = tenant
    if (!currentUser || currentRole !== "tenant") {
      conversationsSectionEl.classList.add("hidden");
      conversationsListEl.innerHTML = "";
      return;
    }

    const { data, error } = await supabase
      .from("messages")
      .select(`
        id,
        created_at,
        message,
        is_from_landlord,
        is_read_by_tenant,
        hidden_for_tenant,
        listing_id,
        listing (
          title,
          city
        )
      `)
      .eq("tenant_id", currentUser.id)
      .order("created_at", { ascending: false });

    if (error) {
      console.error("loadTenantConversations error", error);
      conversationsSectionEl.classList.add("hidden");
      return;
    }

    if (!data || !data.length) {
      conversationsSectionEl.classList.add("hidden");
      conversationsListEl.innerHTML = "";
      return;
    }

    // группировка по listing_id
    const threadsMap = new Map();
    data.forEach(msg => {
      const listingId = msg.listing_id;
      if (!listingId) return;

      let thread = threadsMap.get(listingId);
      if (!thread) {
        thread = {
          listing_id: listingId,
          listing: msg.listing || { title: "(no title)", city: "" },
          messages: []
        };
        threadsMap.set(listingId, thread);
      }
      thread.messages.push(msg);
    });

    const threads = Array.from(threadsMap.values()).map(thread => {
      const msgs = thread.messages.slice().sort(
        (a, b) => new Date(a.created_at) - new Date(b.created_at)
      );
      const last = msgs[msgs.length - 1];

      const unreadCount = msgs.filter(
        m => m.is_from_landlord && !m.is_read_by_tenant && !m.hidden_for_tenant
      ).length;

      const allHidden = msgs.every(m => m.hidden_for_tenant);

      return {
        ...thread,
        lastMessageAt: last.created_at,
        lastMessageText: last.message || "",
        unreadCount,
        allHidden
      };
    }).sort((a, b) => new Date(b.lastMessageAt) - new Date(a.lastMessageAt));

    const visibleThreads = threads.filter(t => !t.allHidden);

    if (!visibleThreads.length) {
      conversationsSectionEl.classList.add("hidden");
      conversationsListEl.innerHTML = "";
      return;
    }

    conversationsSectionEl.classList.remove("hidden");
    conversationsListEl.innerHTML = "";

    visibleThreads.forEach(thread => {
      const div = document.createElement("div");
      const title = thread.listing.title || "(no title)";
      const city = thread.listing.city || "";
      const dt = new Date(thread.lastMessageAt).toLocaleString();

      const unreadBadge = thread.unreadCount
        ? `<span class="ml-2 bg-rose-100 text-rose-700 text-[10px] font-semibold px-2 py-0.5 rounded-full">
             ${thread.unreadCount} new
           </span>`
        : "";

      div.className =
        "border rounded-xl p-3 flex flex-col gap-1 bg-white hover:bg-slate-50 transition";

      div.innerHTML = `
        <div class="flex justify-between items-center">
          <div class="font-semibold text-sm">
            ${title} — ${city}
            ${unreadBadge}
          </div>
          <div class="text-[11px] text-slate-400">${dt}</div>
        </div>
        <div class="text-xs text-slate-500 line-clamp-2 mb-2">
          ${thread.lastMessageText}
        </div>
        <div class="flex justify-end">
          <button class="px-3 py-1 text-xs rounded-full border border-emerald-300 text-emerald-700 hover:bg-emerald-50">
            Open chat
          </button>
        </div>
      `;

      const btn = div.querySelector("button");
      btn.addEventListener("click", () => {
        window.location.href = `listing-details.html?id=${thread.listing_id}`;
      });

      conversationsListEl.appendChild(div);
    });
  }

  // ---------- ОСНОВНОЙ СПИСОК ОБЪЯВЛЕНИЙ ----------

  async function loadListings() {
    const container = document.getElementById("listingsContainer");
    container.innerHTML = '<p class="text-slate-500">Searching...</p>';

    let query = supabase
      .from("listing")
      .select("*")
      .eq("is_active", true)
      .order("created_at", { ascending: false });

    const city = document.getElementById("filterCity").value.trim();
    if (city) {
      query = query.ilike("city", `%${city}%`);
    }

    const maxPrice = document.getElementById("filterMaxPrice").value;
    if (maxPrice) {
      const val = parseInt(maxPrice, 10);
      if (!Number.isNaN(val)) {
        query = query.lte("price_per_month", val);
      }
    }

    if (document.getElementById("filterWifi").checked) {
      query = query.eq("has_wifi", true);
    }
    if (document.getElementById("filterPets").checked) {
      query = query.eq("allow_pets", true);
    }
    if (document.getElementById("filterFurnished").checked) {
      query = query.eq("is_furnished", true);
    }

    const { data, error } = await query;

    if (error || !data || !data.length) {
      container.innerHTML =
        '<p class="text-slate-500 col-span-full">No listings found.</p>';
      return;
    }

    container.innerHTML = "";
    data.forEach(item => {
      const card = document.createElement("div");
      card.className =
        "bg-white rounded-2xl shadow hover:shadow-lg transition cursor-pointer overflow-hidden group";

      const img = item.main_photo_url || "https://via.placeholder.com/400x300";
      const isFavorite = favoritesSet.has(item.id);

      card.innerHTML = `
        <div class="h-48 overflow-hidden bg-slate-200 relative">
          <img src="${img}" class="w-full h-full object-cover group-hover:scale-105 transition">
          <div class="absolute bottom-2 left-2 bg-black/60 text-white px-2 py-1 rounded-lg text-xs font-bold">
            ${item.price_per_month != null ? "$" + item.price_per_month + "/mo" : ""}
          </div>
        </div>
        <div class="p-4 flex flex-col gap-2">
          <div>
            <h3 class="font-bold text-slate-800 truncate">${item.title || "(no title)"}</h3>
            <p class="text-sm text-slate-500 mb-1">${item.city || ""}</p>
          </div>
          <div class="flex gap-2">
            <button
              class="flex-1 py-2 rounded-xl border border-emerald-600 text-emerald-600 text-sm font-semibold hover:bg-emerald-50 view-details-btn">
              View Details
            </button>
            <button
              class="px-3 py-2 rounded-xl border border-amber-400 text-amber-700 text-xs font-semibold hover:bg-amber-50 favorite-btn"
              data-listing-id="${item.id}"
              data-is-favorite="${isFavorite ? "true" : "false"}">
              ${isFavorite ? "★ In favorites" : "☆ Add to favorites"}
            </button>
          </div>
        </div>
      `;

      // клик по карточке / кнопке "View Details" — открыть объявление
      const open = () => {
        window.location.href = `listing-details.html?id=${item.id}`;
      };

      card.addEventListener("click", open);
      const viewBtn = card.querySelector(".view-details-btn");
      if (viewBtn) {
        viewBtn.addEventListener("click", event => {
          event.stopPropagation();
          open();
        });
      }

      // обработчик избранного
      const favBtn = card.querySelector(".favorite-btn");
      if (favBtn) {
        favBtn.addEventListener("click", async event => {
          event.stopPropagation();
          event.preventDefault();
          await toggleFavoriteButton(favBtn);
        });
      }

      container.appendChild(card);
    });
  }
</script>
</body>
</html>
