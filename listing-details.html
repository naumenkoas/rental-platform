<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Details</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>
</head>
<body class="bg-slate-50 min-h-screen">

  <nav class="bg-white shadow-sm sticky top-0 z-50 p-4 flex justify-between">
    <a href="index.html" class="font-bold text-slate-800">Rental Marketplace</a>
    <button onclick="history.back()" class="text-sm font-semibold">← Back</button>
  </nav>

  <div class="max-w-5xl mx-auto py-8 px-4">
    
    <div id="listingContent" class="grid md:grid-cols-2 gap-8 hidden">
      <div>
        <div class="aspect-video bg-slate-200 rounded-xl overflow-hidden mb-2">
          <img id="mainImg" class="w-full h-full object-cover">
        </div>
        <div id="thumbs" class="grid grid-cols-4 gap-2"></div>
      </div>
      <div>
        <h1 id="title" class="text-3xl font-bold mb-1">Loading...</h1>
        <p id="city" class="text-slate-500 mb-4"></p>
        <div class="text-2xl font-bold text-emerald-600 mb-6" id="price"></div>
        <p id="desc" class="text-slate-700 whitespace-pre-wrap mb-6"></p>
        
        <div class="bg-white border rounded-xl shadow-sm p-4">
          <h3 class="font-bold border-b pb-2 mb-2">Chat with Landlord</h3>
          <div id="chatBox" class="h-64 overflow-y-auto bg-slate-50 p-3 rounded mb-3 text-sm flex flex-col gap-2">
            <p class="text-slate-400 text-center mt-10">Sign in to view history or start chatting.</p>
          </div>
          <div class="flex gap-2">
            <input id="chatMsg" type="text" class="flex-1 border rounded px-3 py-2 text-sm" placeholder="Type message...">
            <button id="sendBtn" class="bg-slate-800 text-white px-4 py-2 rounded font-bold text-sm">Send</button>
          </div>
          <input id="guestEmail" class="w-full mt-2 border rounded px-3 py-2 text-sm hidden" placeholder="Your email (required for guests)">
        </div>
      </div>
    </div>
  </div>

<script>
  let listingId, currentUser, role, currentListing;
  
  window.addEventListener('load', async () => {
    if(!window.sb) return;
    const params = new URLSearchParams(window.location.search);
    listingId = params.get('id');
    if(!listingId) { alert("No ID"); return; }

    const {data:{user}} = await window.sb.auth.getUser();
    currentUser = user;
    if(currentUser) {
       const prof = await getCurrentProfile();
       role = prof?.role;
    }

    await loadListing();
    await loadChat();
  });

  async function loadListing() {
    const { data } = await window.sb.from('listing').select('*').eq('id', listingId).single();
    if(!data) return;
    currentListing = data;

    document.getElementById('listingContent').classList.remove('hidden');
    document.getElementById('title').textContent = data.title;
    document.getElementById('city').textContent = data.city;
    document.getElementById('price').textContent = `$${data.price_per_month}/mo`;
    document.getElementById('desc').textContent = data.description;
    
    // Images
    const imgs = [data.main_photo_url, data.photo2_url, data.photo3_url, data.photo4_url].filter(Boolean);
    if(imgs.length) {
       document.getElementById('mainImg').src = imgs[0];
       document.getElementById('thumbs').innerHTML = imgs.map(url => 
         `<img src="${url}" class="h-16 w-full object-cover rounded cursor-pointer border hover:border-emerald-500" onclick="document.getElementById('mainImg').src='${url}'">`
       ).join('');
    }
  }

  // --- CHAT LOGIC ---
  async function loadChat() {
    const box = document.getElementById('chatBox');
    
    // Логика "Чей это чат?"
    let threadId = currentUser ? currentUser.id : null;
    let threadEmail = currentUser ? currentUser.email : null;
    
    // Если смотрит Лендлорд
    if(role === 'landlord' && currentListing.owner_id === currentUser.id) {
       const urlId = new URLSearchParams(window.location.search).get('tenant_id');
       const urlEmail = new URLSearchParams(window.location.search).get('tenant_email');
       
       if(!urlId && !urlEmail) {
         box.innerHTML = '<p class="text-center text-slate-500 mt-10">This is your listing.<br>Check dashboard for messages.</p>';
         document.getElementById('sendBtn').disabled = true;
         return;
       }
       threadId = urlId;
       threadEmail = urlEmail;
    }

    // Гость
    if(!currentUser) {
       document.getElementById('guestEmail').classList.remove('hidden');
       box.innerHTML = '<p class="text-center text-slate-400 mt-2">Guests can send messages, but cannot see history here.</p>';
    } else {
       // Загрузка истории
       let q = window.sb.from('messages').select('*').eq('listing_id', listingId).order('created_at');
       
       if(threadId) q = q.eq('tenant_id', threadId);
       else if(threadEmail) q = q.eq('tenant_email', threadEmail);
       
       const {data} = await q;
       if(data) {
         box.innerHTML = '';
         data.forEach(m => {
           const isMe = (role === 'landlord' && m.is_from_landlord) || (role !== 'landlord' && !m.is_from_landlord);
           const div = document.createElement('div');
           div.className = `p-2 rounded max-w-[80%] text-sm ${isMe ? 'bg-emerald-100 self-end ml-auto' : 'bg-white border self-start'}`;
           div.textContent = m.message;
           box.appendChild(div);
         });
         box.scrollTop = box.scrollHeight;
       }
    }

    // Отправка
    document.getElementById('sendBtn').onclick = async () => {
       const msg = document.getElementById('chatMsg').value;
       if(!msg) return;
       
       const payload = {
         listing_id: listingId,
         message: msg,
         is_from_landlord: role === 'landlord',
         tenant_id: currentUser ? (role==='tenant'?currentUser.id : threadId) : null,
         tenant_email: currentUser ? (role==='tenant'?currentUser.email : threadEmail) : document.getElementById('guestEmail').value
       };

       if(!payload.tenant_email) { alert("Email required for guest"); return; }
       
       await window.sb.from('messages').insert(payload);
       document.getElementById('chatMsg').value = '';
       if(currentUser) loadChat(); 
       else alert('Message sent!');
    }
  }
</script>
</body>
</html>
