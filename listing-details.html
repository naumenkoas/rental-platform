<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Listing details</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-100 min-h-screen">
  <div class="max-w-4xl mx-auto py-8 px-4">
    <header class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold text-slate-800">Listing details</h1>
      <a href="javascript:history.back()"
         class="px-4 py-2 rounded-xl bg-slate-800 text-white text-sm font-semibold hover:bg-slate-900 transition">
        Back
      </a>
    </header>

    <section id="status" class="mb-4 text-sm text-slate-600">
      Loading listing...
    </section>

    <!-- БЛОК ОБЪЯВЛЕНИЯ -->
    <section id="content" class="bg-white rounded-2xl shadow p-6 space-y-6 hidden">
      <div>
        <h2 id="title" class="text-2xl font-semibold text-slate-900"></h2>
        <p id="city" class="text-slate-700"></p>
        <p id="price" class="text-lg font-semibold text-emerald-700 mt-2"></p>
        <p id="flags" class="text-sm text-slate-600 mt-1"></p>
      </div>

      <div>
        <h3 class="text-lg font-semibold mb-2">Description</h3>
        <p id="description" class="text-slate-700 whitespace-pre-line"></p>
      </div>

      <div id="photosBlock">
        <h3 class="text-lg font-semibold mb-2">Photos</h3>
        <div id="photos" class="flex flex-wrap gap-3"></div>
        <p id="noPhotos" class="text-sm text-slate-500 hidden">No photos.</p>
      </div>

      <div class="text-xs text-slate-400">
        <span id="meta"></span>
      </div>
    </section>

    <!-- БЛОК ЧАТА / СООБЩЕНИЙ -->
    <section id="chatSection" class="mt-6 hidden">
      <div class="bg-white rounded-2xl shadow p-5 flex flex-col gap-3">
        <div class="flex justify-between items-center">
          <div>
            <h2 class="text-lg font-semibold text-slate-800" id="chatTitle">Conversation</h2>
            <p id="chatInfo" class="text-xs text-slate-500"></p>
          </div>
          <button id="toggleHideBtn"
            class="text-xs px-3 py-1 rounded-full border border-amber-300 text-amber-700 hover:bg-amber-50 transition hidden">
            Hide conversation
          </button>
        </div>

        <div id="chatMessages"
             class="border rounded-xl p-3 bg-slate-50 h-72 overflow-y-auto text-sm text-slate-800">
          Loading messages...
        </div>

        <div id="chatFooter" class="flex flex-col gap-2">
          <textarea id="chatInput" rows="3" placeholder="Type your message..."
            class="w-full px-3 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 text-sm"></textarea>
          <div class="flex justify-between items-center gap-2">
            <input id="chatEmail" type="email" placeholder="Your email (for guests)"
              class="flex-1 px-3 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 text-xs hidden" />
            <button id="sendBtn"
              class="px-4 py-2 rounded-xl bg-emerald-600 text-white text-sm font-semibold hover:bg-emerald-700 transition">
              Send
            </button>
          </div>
          <p id="chatStatus" class="text-xs text-slate-500"></p>
        </div>
      </div>
    </section>

    <!-- ФОРМА ДЛЯ ГОСТЕЙ (разовое сообщение) -->
    <section id="guestSection" class="mt-6 hidden">
      <div class="bg-white rounded-2xl shadow p-5 flex flex-col gap-3">
        <h2 class="text-lg font-semibold text-slate-800">Contact landlord</h2>
        <p class="text-xs text-slate-500">
          You can send a single message as a guest.  
          For full chat history, please <a href="register.html" class="text-emerald-700 underline">sign up</a> as a tenant.
        </p>
        <textarea id="guestMessage" rows="3" placeholder="Your message..."
          class="w-full px-3 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 text-sm"></textarea>
        <input id="guestEmail" type="email" placeholder="Your email"
          class="w-full px-3 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 text-sm" />
        <button id="guestSendBtn"
          class="px-4 py-2 rounded-xl bg-emerald-600 text-white text-sm font-semibold hover:bg-emerald-700 transition">
          Send message
        </button>
        <p id="guestStatus" class="text-xs text-slate-500"></p>
      </div>
    </section>
  </div>

<script>
  const supabaseUrl = "https://zzkriumjamchjrxdxhzf.supabase.co";
  const supabaseKey =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp6a3JpdW1qYW1jaGpyeGR4aHpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNDkyNDcsImV4cCI6MjA3OTgyNTI0N30.mK7jN6En9SWhr2Avt545CIGm58Kd7ACgs8hGOe4UKMU";
  const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

  const statusEl = document.getElementById("status");
  const contentEl = document.getElementById("content");
  const chatSectionEl = document.getElementById("chatSection");
  const chatMessagesEl = document.getElementById("chatMessages");
  const chatInfoEl = document.getElementById("chatInfo");
  const chatTitleEl = document.getElementById("chatTitle");
  const chatInputEl = document.getElementById("chatInput");
  const chatEmailEl = document.getElementById("chatEmail");
  const chatStatusEl = document.getElementById("chatStatus");
  const sendBtnEl = document.getElementById("sendBtn");
  const toggleHideBtn = document.getElementById("toggleHideBtn");

  const guestSectionEl = document.getElementById("guestSection");
  const guestMessageEl = document.getElementById("guestMessage");
  const guestEmailEl = document.getElementById("guestEmail");
  const guestSendBtn = document.getElementById("guestSendBtn");
  const guestStatusEl = document.getElementById("guestStatus");

  let currentUser = null;
  let currentProfile = null;
  let currentListing = null;

  let threadTenantId = null;
  let threadTenantEmail = null;

  let currentRoleForChat = null; // "landlord" | "tenant"

  function setStatus(text, isError = false) {
    statusEl.textContent = text;
    statusEl.className =
      "mb-4 text-sm " + (isError ? "text-red-600" : "text-slate-600");
  }

  function setChatStatus(text, isError = false) {
    chatStatusEl.textContent = text || "";
    chatStatusEl.className =
      "text-xs " + (isError ? "text-red-600" : "text-slate-500");
  }

  function setGuestStatus(text, isError = false) {
    guestStatusEl.textContent = text || "";
    guestStatusEl.className =
      "text-xs " + (isError ? "text-red-600" : "text-slate-500");
  }

  window.addEventListener("load", () => {
    init().catch(e => {
      console.error("init error", e);
      setStatus("Error: " + (e.message || e), true);
    });
  });

  async function init() {
    const params = new URLSearchParams(window.location.search);
    const listingId = params.get("id");
    const tenantIdFromUrl = params.get("tenant_id");
    const tenantEmailFromUrl = params.get("tenant_email");

    if (!listingId) {
      setStatus("No listing id in URL.", true);
      return;
    }

    // 1. объявление
    const { data: listing, error: listErr } = await supabase
      .from("listing")
      .select("*")
      .eq("id", listingId)
      .maybeSingle();

    if (listErr) {
      console.error("select listing error", listErr);
      setStatus(listErr.message || "Error loading listing.", true);
      return;
    }
    if (!listing) {
      setStatus("Listing not found.", true);
      return;
    }
    currentListing = listing;
    fillListing(listing);

    // 2. auth + профиль
    const { data: authData } = await supabase.auth.getUser();
    if (authData && authData.user) {
      currentUser = authData.user;
      const { data: profile, error: profErr } = await supabase
        .from("profiles")
        .select("role")
        .eq("id", currentUser.id)
        .maybeSingle();
      if (!profErr && profile) {
        currentProfile = profile;
      }
    }

    if (currentListing.is_active === false) {
      setStatus("This listing is inactive.", false);
      chatSectionEl.classList.remove("hidden");
      chatMessagesEl.textContent = "Messaging is disabled for inactive listings.";
      document.getElementById("chatFooter").classList.add("hidden");
      return;
    }

    const isLandlord = currentProfile && currentProfile.role === "landlord";
    const isTenant = currentProfile && currentProfile.role === "tenant";

    // ГОСТЬ
    if (!currentUser) {
      setStatus("", false);
      contentEl.classList.remove("hidden");
      guestSectionEl.classList.remove("hidden");
      setupGuestForm(listingId);
      return;
    }

    // ЛЕНДЛОРД
    if (isLandlord) {
      setStatus("", false);
      contentEl.classList.remove("hidden");

      if (!tenantIdFromUrl && !tenantEmailFromUrl) {
        chatSectionEl.classList.remove("hidden");
        chatMessagesEl.textContent =
          "To see a conversation, open this page from your Dashboard inbox.";
        document.getElementById("chatFooter").classList.add("hidden");
        return;
      }

      threadTenantId = tenantIdFromUrl || null;
      threadTenantEmail = tenantEmailFromUrl || null;
      currentRoleForChat = "landlord";

      chatSectionEl.classList.remove("hidden");
      document.getElementById("chatFooter").classList.remove("hidden");
      toggleHideBtn.classList.remove("hidden");
      chatTitleEl.textContent = "Conversation with tenant";
      chatInfoEl.textContent =
        threadTenantEmail
          ? `Tenant email: ${threadTenantEmail}`
          : "Registered tenant";

      chatEmailEl.classList.add("hidden");

      toggleHideBtn.addEventListener("click", toggleHideConversationForLandlord);
      sendBtnEl.addEventListener("click", () => sendMessageAsLandlord(listingId));

      await loadMessagesForThread(listingId, "landlord");
      return;
    }

    // ТЕНАНТ
    if (isTenant) {
      setStatus("", false);
      contentEl.classList.remove("hidden");

      threadTenantId = currentUser.id;
      threadTenantEmail = currentUser.email || null;
      currentRoleForChat = "tenant";

      chatSectionEl.classList.remove("hidden");
      document.getElementById("chatFooter").classList.remove("hidden");
      toggleHideBtn.classList.remove("hidden");
      chatTitleEl.textContent = "Conversation with landlord";
      chatInfoEl.textContent = "You are logged in as tenant.";
      chatEmailEl.classList.add("hidden");

      toggleHideBtn.addEventListener("click", toggleHideConversationForTenant);
      sendBtnEl.addEventListener("click", () => sendMessageAsTenant(listingId));

      await loadMessagesForThread(listingId, "tenant");
      return;
    }

    // Остальные роли — просто объявление
    setStatus("", false);
    contentEl.classList.remove("hidden");
    chatSectionEl.classList.remove("hidden");
    chatMessagesEl.textContent =
      "Messaging is available only for landlords and tenants.";
    document.getElementById("chatFooter").classList.add("hidden");
  }

  function fillListing(data) {
    document.getElementById("title").textContent = data.title || "(no title)";
    document.getElementById("city").textContent = data.city || "";
    document.getElementById("price").textContent =
      data.price_per_month != null ? data.price_per_month + " / month" : "";

    const flags = [];
    if (data.has_wifi) flags.push("Wi-Fi");
    if (data.allow_pets) flags.push("Pets allowed");
    if (data.is_furnished) flags.push("Furnished");
    if (data.is_active === false) flags.push("Inactive listing");
    document.getElementById("flags").textContent = flags.join(" • ");

    document.getElementById("description").textContent =
      data.description || "";

    document.getElementById("meta").textContent =
      "id: " + data.id +
      (data.created_at ? " • created at: " + data.created_at : "") +
      (data.owner_id ? " • owner_id: " + data.owner_id : "");

    const urls = [
      data.main_photo_url,
      data.photo2_url,
      data.photo3_url,
      data.photo4_url
    ].filter(u => !!u);

    const photosEl = document.getElementById("photos");
    const noPhotosEl = document.getElementById("noPhotos");

    if (!urls.length) {
      photosEl.innerHTML = "";
      noPhotosEl.classList.remove("hidden");
    } else {
      noPhotosEl.classList.add("hidden");
      photosEl.innerHTML = "";
      urls.forEach((url, idx) => {
        const a = document.createElement("a");
        a.href = url;
        a.target = "_blank";
        a.rel = "noopener noreferrer";

        const img = document.createElement("img");
        img.src = url;
        img.alt = "photo " + (idx + 1);
        img.className = "w-32 h-32 object-cover rounded-xl border";

        a.appendChild(img);
        photosEl.appendChild(a);
      });
    }

    setStatus("", false);
    contentEl.classList.remove("hidden");
  }

  // --------- ГОСТЕВОЕ СООБЩЕНИЕ ---------

  function setupGuestForm(listingId) {
    guestSectionEl.classList.remove("hidden");
    guestSendBtn.addEventListener("click", async () => {
      const msg = guestMessageEl.value.trim();
      const email = guestEmailEl.value.trim();

      if (!msg || !email) {
        setGuestStatus("Message and email are required.", true);
        return;
      }

      setGuestStatus("Sending...");

      const { error } = await supabase.from("messages").insert([
        {
          listing_id: listingId,
          tenant_id: null,
          tenant_email: email,
          message: msg,
          is_from_landlord: false,
          is_read_by_landlord: false,
          is_read_by_tenant: false,
          hidden_for_landlord: false,
          hidden_for_tenant: false
        }
      ]);

      if (error) {
        console.error("guest send error", error);
        setGuestStatus(error.message || "Failed to send message.", true);
        return;
      }

      guestMessageEl.value = "";
      setGuestStatus("Message sent.");
    });
  }

  // --------- ЗАГРУЗКА СООБЩЕНИЙ ДЛЯ ТРЕДА ---------

  async function loadMessagesForThread(listingId, role) {
    if (!listingId) return;
    if (!threadTenantId && !threadTenantEmail) {
      chatMessagesEl.textContent = "No conversation selected.";
      return;
    }

    chatMessagesEl.textContent = "Loading messages...";

    let query = supabase
      .from("messages")
      .select("*")
      .eq("listing_id", listingId)
      .order("created_at", { ascending: true });

    // не фильтруем hidden_* специально, чтобы можно было вернуть скрытый диалог
    if (role === "landlord") {
      if (threadTenantId) {
        query = query.eq("tenant_id", threadTenantId);
      } else if (threadTenantEmail) {
        query = query.eq("tenant_email", threadTenantEmail);
      }
    } else if (role === "tenant") {
      query = query.eq("tenant_id", threadTenantId);
    }

    const { data, error } = await query;

    if (error) {
      console.error("loadMessagesForThread error", error);
      chatMessagesEl.textContent = error.message || "Error loading messages.";
      return;
    }

    if (!data || data.length === 0) {
      chatMessagesEl.textContent = "No messages yet. Start the conversation.";
      toggleHideBtn.textContent = "Hide conversation";
      return;
    }

    const allHiddenForLandlord =
      role === "landlord" && data.every(m => m.hidden_for_landlord);
    const allHiddenForTenant =
      role === "tenant" && data.every(m => m.hidden_for_tenant);

    const isHiddenForRole =
      (role === "landlord" && allHiddenForLandlord) ||
      (role === "tenant" && allHiddenForTenant);

    // помечаем прочитанными
    const idsToMark = [];
    if (role === "landlord") {
      data.forEach(msg => {
        if (!msg.is_from_landlord && !msg.is_read_by_landlord) {
          idsToMark.push(msg.id);
        }
      });
      if (idsToMark.length) {
        await supabase
          .from("messages")
          .update({ is_read_by_landlord: true })
          .in("id", idsToMark);
      }
    } else if (role === "tenant") {
      data.forEach(msg => {
        if (msg.is_from_landlord && !msg.is_read_by_tenant) {
          idsToMark.push(msg.id);
        }
      });
      if (idsToMark.length) {
        await supabase
          .from("messages")
          .update({ is_read_by_tenant: true })
          .in("id", idsToMark);
      }
    }

    if (isHiddenForRole) {
      chatMessagesEl.innerHTML =
        '<p class="text-xs text-slate-500">Conversation is hidden. Click “Show conversation” to see messages again.</p>';
      toggleHideBtn.textContent = "Show conversation";
      return;
    }

    toggleHideBtn.textContent = "Hide conversation";

    // отрисуем только НЕ скрытые сообщения
    const filtered = data.filter(msg =>
      role === "landlord" ? !msg.hidden_for_landlord : !msg.hidden_for_tenant
    );

    if (!filtered.length) {
      chatMessagesEl.textContent =
        "No visible messages. Conversation might be partially hidden.";
      return;
    }

    chatMessagesEl.innerHTML = "";

    filtered.forEach(msg => {
      const wrapper = document.createElement("div");
      const mine =
        (role === "landlord" && msg.is_from_landlord) ||
        (role === "tenant" && !msg.is_from_landlord);

      wrapper.className =
        "mb-2 flex " + (mine ? "justify-end" : "justify-start");

      const bubble = document.createElement("div");
      bubble.className =
        "max-w-[70%] rounded-2xl px-3 py-2 text-sm whitespace-pre-line " +
        (mine
          ? "bg-emerald-600 text-white rounded-br-sm"
          : "bg-white text-slate-800 border rounded-bl-sm");

      const time = new Date(msg.created_at).toLocaleString();
      const meta = mine
        ? (role === "landlord" ? "You (landlord)" : "You")
        : (role === "landlord" ? "Tenant" : "Landlord");

      let deleteBtnHtml = "";
      const canDelete =
        (role === "landlord" && msg.is_from_landlord && !msg.is_read_by_tenant) ||
        (role === "tenant" && !msg.is_from_landlord && !msg.is_read_by_landlord);

      if (canDelete) {
        deleteBtnHtml =
          `<button data-id="${msg.id}" class="ml-2 text-[10px] text-red-200 underline decoration-dotted hover:text-red-100">
             delete
           </button>`;
      }

      bubble.innerHTML = `
        <div class="text-[10px] mb-1 opacity-75 flex items-center">
          <span>${meta} • ${time}</span>
          ${deleteBtnHtml}
        </div>
        <div>${msg.message || ""}</div>
      `;

      wrapper.appendChild(bubble);
      chatMessagesEl.appendChild(wrapper);

      if (canDelete) {
        bubble
          .querySelector("button[data-id]")
          .addEventListener("click", () => deleteMessage(msg.id));
      }
    });

    chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
  }

  async function deleteMessage(messageId) {
    if (!confirm("Delete this message? It is allowed only while it is unread by the other side.")) {
      return;
    }

    const { error } = await supabase
      .from("messages")
      .delete()
      .eq("id", messageId);

    if (error) {
      console.error("deleteMessage error", error);
      alert(error.message || "Failed to delete message.");
      return;
    }

    await loadMessagesForThread(currentListing.id, currentRoleForChat);
  }

  // --------- ОТПРАВКА ---------

  async function sendMessageAsTenant(listingId) {
    const text = chatInputEl.value.trim();
    if (!text) {
      setChatStatus("Message is empty.", true);
      return;
    }

    setChatStatus("Sending...");

    const { error } = await supabase.from("messages").insert([
      {
        listing_id: listingId,
        tenant_id: threadTenantId,
        tenant_email: threadTenantEmail,
        message: text,
        is_from_landlord: false,
        is_read_by_landlord: false,
        is_read_by_tenant: false,
        hidden_for_landlord: false,
        hidden_for_tenant: false
      }
    ]);

    if (error) {
      console.error("sendMessageAsTenant error", error);
      setChatStatus(error.message || "Failed to send.", true);
      return;
    }

    chatInputEl.value = "";
    setChatStatus("Message sent.");
    await loadMessagesForThread(listingId, "tenant");
  }

  async function sendMessageAsLandlord(listingId) {
    const text = chatInputEl.value.trim();
    if (!text) {
      setChatStatus("Message is empty.", true);
      return;
    }

    setChatStatus("Sending...");

    const { error } = await supabase.from("messages").insert([
      {
        listing_id: listingId,
        tenant_id: threadTenantId,
        tenant_email: threadTenantEmail,
        message: text,
        is_from_landlord: true,
        is_read_by_landlord: true,
        is_read_by_tenant: false,
        hidden_for_landlord: false,
        hidden_for_tenant: false
      }
    ]);

    if (error) {
      console.error("sendMessageAsLandlord error", error);
      setChatStatus(error.message || "Failed to send.", true);
      return;
    }

    chatInputEl.value = "";
    setChatStatus("Message sent.");
    await loadMessagesForThread(listingId, "landlord");
  }

  // --------- СКРЫТИЕ / ПОКАЗ ДИАЛОГА ---------

  async function toggleHideConversationForTenant() {
    if (!threadTenantId) return;

    // смотрим, сейчас скрыто или нет
    const { data, error } = await supabase
      .from("messages")
      .select("id, hidden_for_tenant")
      .eq("listing_id", currentListing.id)
      .eq("tenant_id", threadTenantId);

    if (error) {
      console.error("check hide tenant error", error);
      alert(error.message || "Failed to check conversation state.");
      return;
    }

    const allHidden = data && data.length && data.every(m => m.hidden_for_tenant);
    const newHidden = !allHidden;

    const confirmText = newHidden
      ? "Hide this conversation for you?"
      : "Show this conversation again?";
    if (!confirm(confirmText)) return;

    const { error: updErr } = await supabase
      .from("messages")
      .update({ hidden_for_tenant: newHidden })
      .eq("listing_id", currentListing.id)
      .eq("tenant_id", threadTenantId);

    if (updErr) {
      console.error("hideConversationForTenant error", updErr);
      alert(updErr.message || "Failed to update conversation visibility.");
      return;
    }

    await loadMessagesForThread(currentListing.id, "tenant");
  }

  async function toggleHideConversationForLandlord() {
    if (!threadTenantId && !threadTenantEmail) return;

    const filters = supabase
      .from("messages")
      .select("id, hidden_for_landlord")
      .eq("listing_id", currentListing.id);

    let query = filters;
    if (threadTenantId) {
      query = query.eq("tenant_id", threadTenantId);
    } else if (threadTenantEmail) {
      query = query.eq("tenant_email", threadTenantEmail);
    }

    const { data, error } = await query;
    if (error) {
      console.error("check hide landlord error", error);
      alert(error.message || "Failed to check conversation state.");
      return;
    }

    const allHidden = data && data.length && data.every(m => m.hidden_for_landlord);
    const newHidden = !allHidden;

    const confirmText = newHidden
      ? "Hide this conversation from your view?"
      : "Show this conversation again?";
    if (!confirm(confirmText)) return;

    let upd = supabase
      .from("messages")
      .update({ hidden_for_landlord: newHidden })
      .eq("listing_id", currentListing.id);

    if (threadTenantId) {
      upd = upd.eq("tenant_id", threadTenantId);
    } else if (threadTenantEmail) {
      upd = upd.eq("tenant_email", threadTenantEmail);
    }

    const { error: updErr } = await upd;
    if (updErr) {
      console.error("hideConversationForLandlord error", updErr);
      alert(updErr.message || "Failed to update conversation visibility.");
      return;
    }

    await loadMessagesForThread(currentListing.id, "landlord");
  }
</script>
</body>
</html>
