<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Listing details</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-100 min-h-screen">
  <div class="max-w-4xl mx-auto py-8 px-4">
    <header class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold text-slate-800">Listing details</h1>
      <a href="javascript:history.back()"
         class="px-4 py-2 rounded-xl bg-slate-800 text-white text-sm font-semibold hover:bg-slate-900 transition">
        Back
      </a>
    </header>

    <section id="status" class="mb-4 text-sm text-slate-600">
      Loading listing...
    </section>

    <!-- БЛОК ОБЪЯВЛЕНИЯ -->
    <section id="content" class="bg-white rounded-2xl shadow p-6 space-y-6 hidden">
      <div>
        <h2 id="title" class="text-2xl font-semibold text-slate-900"></h2>
        <p id="city" class="text-slate-700"></p>
        <p id="price" class="text-lg font-semibold text-emerald-700 mt-2"></p>
        <p id="flags" class="text-sm text-slate-600 mt-1"></p>

        <!-- КНОПКА ИЗБРАННОГО ДЛЯ TENANT -->
        <button id="favBtn"
          class="mt-3 px-3 py-1 rounded-xl border border-emerald-600 text-emerald-700 text-xs font-semibold hover:bg-emerald-50 hidden">
          ☆ Add to favorites
        </button>
        <p id="favStatus" class="text-xs text-slate-500 mt-1"></p>
      </div>

      <div>
        <h3 class="text-lg font-semibold mb-2">Description</h3>
        <p id="description" class="text-slate-700 whitespace-pre-line"></p>
      </div>

      <div id="photosBlock">
        <h3 class="text-lg font-semibold mb-2">Photos</h3>
        <div id="photos" class="flex flex-wrap gap-3"></div>
        <p id="noPhotos" class="text-sm text-slate-500 hidden">No photos.</p>
      </div>

      <div class="text-xs text-slate-400">
        <span id="meta"></span>
      </div>
    </section>

    <!-- БЛОК ЧАТА / СООБЩЕНИЙ -->
    <section id="chatSection" class="mt-6 hidden">
      <div class="bg-white rounded-2xl shadow p-5 flex flex-col gap-3">
        <div class="flex justify-between items-center">
          <div>
            <h2 class="text-lg font-semibold text-slate-800" id="chatTitle">Conversation</h2>
            <p id="chatInfo" class="text-xs text-slate-500"></p>
          </div>
          <button id="toggleHideBtn"
            class="text-xs px-3 py-1 rounded-full border border-amber-300 text-amber-700 hover:bg-amber-50 transition hidden">
            Hide conversation
          </button>
        </div>

        <div id="chatMessages"
             class="border rounded-xl p-3 bg-slate-50 h-72 overflow-y-auto text-sm text-slate-800">
          Loading messages...
        </div>

        <div id="chatFooter" class="flex flex-col gap-2">
          <textarea id="chatInput" rows="3" placeholder="Type your message..."
            class="w-full px-3 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 text-sm"></textarea>
          <div class="flex justify-between items-center gap-2">
            <input id="chatEmail" type="email" placeholder="Your email (for guests)"
              class="flex-1 px-3 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 text-xs hidden" />
            <button id="sendBtn"
              class="px-4 py-2 rounded-xl bg-emerald-600 text-white text-sm font-semibold hover:bg-emerald-700 transition">
              Send
            </button>
          </div>
          <p id="chatStatus" class="text-xs text-slate-500"></p>
        </div>
      </div>
    </section>

    <!-- ФОРМА ДЛЯ ГОСТЕЙ (разовое сообщение) -->
    <section id="guestSection" class="mt-6 hidden">
      <div class="bg-white rounded-2xl shadow p-5 flex flex-col gap-3">
        <h2 class="text-lg font-semibold text-slate-800">Contact landlord</h2>
        <p class="text-xs text-slate-500">
          You can send a single message as a guest.  
          For full chat history, please <a href="register.html" class="text-emerald-700 underline">sign up</a> as a tenant.
        </p>
        <textarea id="guestMessage" rows="3" placeholder="Your message..."
          class="w-full px-3 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 text-sm"></textarea>
        <input id="guestEmail" type="email" placeholder="Your email"
          class="w-full px-3 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 text-sm" />
        <button id="guestSendBtn"
          class="px-4 py-2 rounded-xl bg-emerald-600 text-white text-sm font-semibold hover:bg-emerald-700 transition">
          Send message
        </button>
        <p id="guestStatus" class="text-xs text-slate-500"></p>
      </div>
    </section>
  </div>

<script>
  const supabaseUrl = "https://zzkriumjamchjrxdxhzf.supabase.co";
  const supabaseKey =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp6a3JpdW1qYW1jaGpyeGR4aHpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNDkyNDcsImV4cCI6MjA3OTgyNTI0N30.mK7jN6En9SWhr2Avt545CIGm58Kd7ACgs8hGOe4UKMU";
  const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

  const statusEl = document.getElementById("status");
  const contentEl = document.getElementById("content");
  const chatSectionEl = document.getElementById("chatSection");
  const chatMessagesEl = document.getElementById("chatMessages");
  const chatInfoEl = document.getElementById("chatInfo");
  const chatTitleEl = document.getElementById("chatTitle");
  const chatInputEl = document.getElementById("chatInput");
  const chatEmailEl = document.getElementById("chatEmail");
  const chatStatusEl = document.getElementById("chatStatus");
  const sendBtnEl = document.getElementById("sendBtn");
  const toggleHideBtn = document.getElementById("toggleHideBtn");

  const guestSectionEl = document.getElementById("guestSection");
  const guestMessageEl = document.getElementById("guestMessage");
  const guestEmailEl = document.getElementById("guestEmail");
  const guestSendBtn = document.getElementById("guestSendBtn");
  const guestStatusEl = document.getElementById("guestStatus");

  const favBtnEl = document.getElementById("favBtn");
  const favStatusEl = document.getElementById("favStatus");

  let currentUser = null;
  let currentProfile = null;
  let currentListing = null;

  let threadTenantId = null;
  let threadTenantEmail = null;

  let currentRoleForChat = null; // "landlord" | "tenant"

  // состояние избранного для текущего объявления
  let isFavorite = false;

  function setStatus(text, isError = false) {
    statusEl.textContent = text;
    statusEl.className =
      "mb-4 text-sm " + (isError ? "text-red-600" : "text-slate-600");
  }

  function setChatStatus(text, isError = false) {
    chatStatusEl.textContent = text || "";
    chatStatusEl.className =
      "text-xs " + (isError ? "text-red-600" : "text-slate-500");
  }

  function setGuestStatus(text, isError = false) {
    guestStatusEl.textContent = text || "";
    guestStatusEl.className =
      "text-xs " + (isError ? "text-red-600" : "text-slate-500");
  }

  function setFavStatus(text, isError = false) {
    favStatusEl.textContent = text || "";
    favStatusEl.className =
      "text-xs mt-1 " + (isError ? "text-red-600" : "text-slate-500");
  }

  function updateFavButtonUI() {
    if (!favBtnEl) return;
    if (!currentUser || !currentProfile || currentProfile.role !== "tenant") {
      favBtnEl.classList.add("hidden");
      return;
    }
    favBtnEl.classList.remove("hidden");
    favBtnEl.textContent = isFavorite ? "★ In favorites" : "☆ Add to favorites";
  }

  window.addEventListener("load", () => {
    init().catch(e => {
      console.error("init error", e);
      setStatus("Error: " + (e.message || e), true);
    });
  });

  async function init() {
    const params = new URLSearchParams(window.location.search);
    const listingId = params.get("id");
    const tenantIdFromUrl = params.get("tenant_id");
    const tenantEmailFromUrl = params.get("tenant_email");

    if (!listingId) {
      setStatus("No listing id in URL.", true);
      return;
    }

    // 1. объявление
    const { data: listing, error: listErr } = await supabase
      .from("listing")
      .select("*")
      .eq("id", listingId)
      .maybeSingle();

    if (listErr) {
      console.error("select listing error", listErr);
      setStatus(listErr.message || "Error loading listing.", true);
      return;
    }
    if (!listing) {
      setStatus("Listing not found.", true);
      return;
    }
    currentListing = listing;
    fillListing(listing);

    // 2. auth + профиль
    const { data: authData } = await supabase.auth.getUser();
    if (authData && authData.user) {
      currentUser = authData.user;
      const { data: profile, error: profErr } = await supabase
        .from("profiles")
        .select("role")
        .eq("id", currentUser.id)
        .maybeSingle();
      if (!profErr && profile) {
        currentProfile = profile;
      }
    }

    if (currentListing.is_active === false) {
      setStatus("This listing is inactive.", false);
      contentEl.classList.remove("hidden");
      chatSectionEl.classList.remove("hidden");
      chatMessagesEl.textContent = "Messaging is disabled for inactive listings.";
      document.getElementById("chatFooter").classList.add("hidden");
      // избранное для неактивного тоже можно, но не принципиально
      await initFavoritesForTenant(listingId);
      return;
    }

    const isLandlord = currentProfile && currentProfile.role === "landlord";
    const isTenant = currentProfile && currentProfile.role === "tenant";

    // ГОСТЬ
    if (!currentUser) {
      setStatus("", false);
      contentEl.classList.remove("hidden");
      guestSectionEl.classList.remove("hidden");
      setupGuestForm(listingId);
      // гость не видит избранное
      updateFavButtonUI();
      return;
    }

    // ЛЕНДЛОРД
    if (isLandlord) {
      setStatus("", false);
      contentEl.classList.remove("hidden");

      // избранное для лендлорда сейчас не делаем
      updateFavButtonUI();

      if (!tenantIdFromUrl && !tenantEmailFromUrl) {
        chatSectionEl.classList.remove("hidden");
        chatMessagesEl.textContent =
          "To see a conversation, open this page from your Dashboard inbox.";
        document.getElementById("chatFooter").classList.add("hidden");
        return;
      }

      threadTenantId = tenantIdFromUrl || null;
      threadTenantEmail = tenantEmailFromUrl || null;
      currentRoleForChat = "landlord";

      chatSectionEl.classList.remove("hidden");
      document.getElementById("chatFooter").classList.remove("hidden");
      toggleHideBtn.classList.remove("hidden");
      chatTitleEl.textContent = "Conversation with tenant";
      chatInfoEl.textContent =
        threadTenantEmail
          ? `Tenant email: ${threadTenantEmail}`
          : "Registered tenant";

      chatEmailEl.classList.add("hidden");

      toggleHideBtn.addEventListener("click", toggleHideConversationForLandlord);
      sendBtnEl.addEventListener("click", () => sendMessageAsLandlord(listingId));

      await loadMessagesForThread(listingId, "landlord");
      return;
    }

    // ТЕНАНТ
    if (isTenant) {
      setStatus("", false);
      contentEl.classList.remove("hidden");

      threadTenantId = currentUser.id;
      threadTenantEmail = currentUser.email || null;
      currentRoleForChat = "tenant";

      chatSectionEl.classList.remove("hidden");
      document.getElementById("chatFooter").classList.remove("hidden");
      toggleHideBtn.classList.remove("hidden");
      chatTitleEl.textContent = "Conversation with landlord";
      chatInfoEl.textContent = "You are logged in as tenant.";
      chatEmailEl.classList.add("hidden");

      toggleHideBtn.addEventListener("click", toggleHideConversationForTenant);
      sendBtnEl.addEventListener("click", () => sendMessageAsTenant(listingId));

      // инициализация избранного для tenant
      await initFavoritesForTenant(listingId);

      await loadMessagesForThread(listingId, "tenant");
      return;
    }

    // Остальные роли — просто объявление
    setStatus("", false);
    contentEl.classList.remove("hidden");
    chatSectionEl.classList.remove("hidden");
    chatMessagesEl.textContent =
      "Messaging is available only for landlords and tenants.";
    document.getElementById("chatFooter").classList.add("hidden");

    updateFavButtonUI();
  }

  function fillListing(data) {
    document.getElementById("title").textContent = data.title || "(no title)";
    document.getElementById("city").textContent = data.city || "";
    document.getElementById("price").textContent =
      data.price_per_month != null ? data.price_per_month + " / month" : "";

    const flags = [];
    if (data.has_wifi) flags.push("Wi-Fi");
    if (data.allow_pets) flags.push("Pets allowed");
    if (data.is_furnished) flags.push("Furnished");
    if (data.is_active === false) flags.push("Inactive listing");
    document.getElementById("flags").textContent = flags.join(" • ");

    document.getElementById("description").textContent =
      data.description || "";

    document.getElementById("meta").textContent =
      "id: " + data.id +
      (data.created_at ? " • created at: " + data.created_at : "") +
      (data.owner_id ? " • owner_id: " + data.owner_id : "");

    const urls = [
      data.main_photo_url,
      data.photo2_url,
      data.photo3_url,
      data.photo4_url
    ].filter(u => !!u);

    const photosEl = document.getElementById("photos");
    const noPhotosEl = document.getElementById("noPhotos");

    if (!urls.length) {
      photosEl.innerHTML = "";
      noPhotosEl.classList.remove("hidden");
    } else {
      noPhotosEl.classList.add("hidden");
      photosEl.innerHTML = "";
      urls.forEach((url, idx) => {
        const a = document.createElement("a");
        a.href = url;
        a.target = "_blank";
        a.rel = "noopener noreferrer";

        const img = document.createElement("img");
        img.src = url;
        img.alt = "photo " + (idx + 1);
        img.className = "w-32 h-32 object-cover rounded-xl border";

        a.appendChild(img);
        photosEl.appendChild(a);
      });
    }

    setStatus("", false);
    contentEl.classList.remove("hidden");
  }

  // --------- ИЗБРАННОЕ ДЛЯ TENANT ---------

  async function initFavoritesForTenant(listingId) {
    if (!currentUser || !currentProfile || currentProfile.role !== "tenant") {
      updateFavButtonUI();
      return;
    }

    // обработчик кнопки
    if (favBtnEl) {
      favBtnEl.onclick = () => toggleFavorite(listingId);
    }

    await loadFavoriteState(listingId);
  }

  async function loadFavoriteState(listingId) {
    if (!currentUser || !currentProfile || currentProfile.role !== "tenant") {
      isFavorite = false;
      updateFavButtonUI();
      return;
    }

    setFavStatus("Checking favorites...");
    const { data, error } = await supabase
      .from("favorites")
      .select("id")
      .eq("user_id", currentUser.id)
      .eq("listing_id", listingId)
      .maybeSingle();

    if (error) {
      // типичная ошибка на 0 строк у maybeSingle в v2 — это не ошибка, но на всякий пожарный логируем
      console.error("loadFavoriteState error", error);
      setFavStatus("Failed to check favorites.", true);
      isFavorite = false;
    } else {
      isFavorite = !!data;
      setFavStatus(isFavorite ? "This listing is in your favorites." : "");
    }

    updateFavButtonUI();
  }

  async function toggleFavorite(listingId) {
    if (!currentUser || !currentProfile || currentProfile.role !== "tenant") {
      setFavStatus("Only logged-in tenants can use favorites.", true);
      return;
    }

    if (!isFavorite) {
      // Добавляем в избранное
      setFavStatus("Adding to favorites...");
      const { error } = await supabase
        .from("favorites")
        .insert([{ listing_id: listingId }]); // user_id подставит default auth.uid()

      if (error) {
        console.error("toggleFavorite insert error", error);
        setFavStatus(error.message || "Failed to add to favorites.", true);
        return;
      }

      isFavorite = true;
      setFavStatus("Added to favorites.");
      updateFavButtonUI();
    } else {
      // Убираем из избранного
      setFavStatus("Removing from favorites...");
      const { error } = await supabase
        .from("favorites")
        .delete()
        .eq("user_id", currentUser.id)
        .eq("listing_id", listingId);

      if (error) {
        console.error("toggleFavorite delete error", error);
        setFavStatus(error.message || "Failed to remove from favorites.", true);
        return;
      }

      isFavorite = false;
      setFavStatus("Removed from favorites.");
      updateFavButtonUI();
    }
  }

  // --------- ГОСТЕВОЕ СООБЩЕНИЕ ---------

  function setupGuestForm(listingId) {
    guestSectionEl.classList.remove("hidden");
    guestSendBtn.addEventListener("click", async () => {
      const msg = guestMessageEl.value.trim();
      const email = guestEmailEl.value.trim();

      if (!msg || !email) {
        setGuestStatus("Message and email are required.", true);
        return;
      }

      setGuestStatus("Sending...");

      const { error } = await supabase.from("messages").insert([
        {
          listing_id: listingId,
          tenant_id: null,
