<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Rental marketplace</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>
</head>
<body class="bg-slate-100 min-h-screen">
  <div class="max-w-6xl mx-auto py-8 px-4">
    
    <header class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold text-slate-800">Rental marketplace</h1>
      <div class="flex gap-2">
        <a href="#search" class="px-4 py-2 border rounded-xl hover:bg-slate-50">Browse as guest</a>
        <a href="register.html" class="px-4 py-2 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700">Sign up</a>
      </div>
    </header>

    <section class="mb-6 grid md:grid-cols-[1.3fr,2fr] gap-4">
      <div class="bg-white rounded-2xl shadow p-5">
        <h2 class="text-lg font-semibold mb-3">Sign in</h2>
        
        <div id="loginForm" class="space-y-2">
          <input id="loginEmail" type="email" placeholder="Email" class="w-full px-3 py-2 border rounded-xl" />
          <input id="loginPassword" type="password" placeholder="Password" class="w-full px-3 py-2 border rounded-xl" />
          <button id="loginBtn" class="w-full px-4 py-2 bg-slate-800 text-white rounded-xl hover:bg-slate-900">Log in</button>
          <p id="loginStatus" class="text-xs mt-1 text-slate-500"></p>
        </div>

        <div id="loggedInActions" class="hidden space-y-2">
          <p id="userInfo" class="text-sm text-slate-600"></p>
          <button id="goDashboardBtn" class="w-full px-4 py-2 bg-emerald-600 text-white rounded-xl">Go to Dashboard</button>
          <button onclick="logout()" class="w-full px-4 py-2 border rounded-xl">Log out</button>
        </div>
      </div>
      
      <div class="bg-white rounded-2xl shadow p-5 flex items-center justify-center text-slate-500 text-sm">
        Log in to chat and manage favorites.
      </div>
    </section>

    <section id="search" class="bg-white rounded-2xl shadow p-5">
      <h2 class="text-lg font-semibold mb-3">Search rentals</h2>
      <div class="flex gap-2 mb-4">
        <input id="filterCity" type="text" placeholder="City" class="border rounded-xl px-3 py-2 w-full">
        <button onclick="loadListings()" class="bg-emerald-600 text-white px-4 py-2 rounded-xl">Search</button>
      </div>
      <div id="listingsContainer" class="grid md:grid-cols-3 gap-4">Loading...</div>
    </section>
  </div>

<script>
  window.addEventListener("load", async () => {
    if (!window.sb) return;
    checkSession();
    loadListings();
  });

  async function checkSession() {
    const { data: { user } } = await window.sb.auth.getUser();
    if (user) {
      const profile = await getCurrentProfile();
      showLoggedInUI(user, profile?.role);
    }
  }

  function showLoggedInUI(user, role) {
    document.getElementById("loginForm").classList.add("hidden");
    document.getElementById("loggedInActions").classList.remove("hidden");
    document.getElementById("userInfo").textContent = `Hello, ${user.email}`;
    
    // ПРЯМОЙ РЕДИРЕКТ
    document.getElementById("goDashboardBtn").onclick = () => {
      if (role === 'landlord') window.location.href = 'landlord.html';
      else window.location.href = 'tenant.html';
    };
  }

  document.getElementById("loginBtn").onclick = async () => {
    const email = document.getElementById("loginEmail").value;
    const password = document.getElementById("loginPassword").value;
    const status = document.getElementById("loginStatus");

    status.textContent = "Signing in...";
    const { error } = await window.sb.auth.signInWithPassword({ email, password });
    
    if (error) {
      status.textContent = error.message;
      status.classList.add("text-red-600");
    } else {
      status.textContent = "Success! Redirecting...";
      // Сразу проверяем сессию и редиректим
      const profile = await getCurrentProfile();
      if (profile?.role === 'landlord') window.location.href = 'landlord.html';
      else window.location.href = 'tenant.html';
    }
  };

  async function loadListings() {
    const city = document.getElementById("filterCity").value;
    let q = window.sb.from("listing").select("*").eq("is_active", true).order("created_at", {ascending:false});
    if(city) q = q.ilike("city", `%${city}%`);
    
    const { data } = await q;
    const cont = document.getElementById("listingsContainer");
    cont.innerHTML = "";
    if(!data || !data.length) { cont.innerHTML = "No active listings."; return; }
    
    data.forEach(item => {
      const div = document.createElement("div");
      div.className = "border rounded-xl p-3 cursor-pointer hover:bg-slate-50";
      div.onclick = () => window.location.href = `listing-details.html?id=${item.id}`;
      div.innerHTML = `
        <img src="${item.main_photo_url || 'https://via.placeholder.com/150'}" class="w-full h-32 object-cover rounded bg-slate-200 mb-2">
        <div class="font-bold">$${item.price_per_month}</div>
        <div class="text-sm">${item.title}</div>
        <div class="text-xs text-slate-500">${item.city}</div>
      `;
      cont.appendChild(div);
    });
  }
</script>
</body>
</html>
