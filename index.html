<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Rental marketplace – Home</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>
</head>
<body class="bg-slate-100 min-h-screen">
  <div class="max-w-6xl mx-auto py-8 px-4">
    
    <header class="flex justify-between items-center mb-6">
      <div>
        <h1 class="text-3xl font-bold text-slate-800">Rental marketplace</h1>
        <p class="text-sm text-slate-600">Guest access enabled.</p>
      </div>
      <div class="flex gap-2">
         <a href="#public-search"
           class="px-4 py-2 rounded-xl border border-slate-300 text-slate-800 text-sm font-semibold hover:bg-slate-50 transition">
          Browse as guest
        </a>
        <a href="register.html" class="px-4 py-2 rounded-xl bg-emerald-600 text-white text-sm font-semibold hover:bg-emerald-700 transition">Sign up</a>
      </div>
    </header>

    <section class="mb-6 grid md:grid-cols-[1.3fr,2fr] gap-4">
      <div class="bg-white rounded-2xl shadow p-5">
        <h2 class="text-lg font-semibold mb-3">Sign in</h2>
        
        <div id="loginForm" class="space-y-2">
          <input id="loginEmail" type="email" placeholder="Email" class="w-full px-3 py-2 border rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none" />
          <input id="loginPassword" type="password" placeholder="Password" class="w-full px-3 py-2 border rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none" />
          <button id="loginBtn" class="w-full px-4 py-2 rounded-xl bg-slate-800 text-white text-sm font-semibold hover:bg-slate-900 transition">Log in</button>
          <p id="loginStatus" class="text-xs mt-1 text-slate-500 min-h-[1rem]"></p>
        </div>

        <div id="loggedInActions" class="hidden space-y-2">
          <p id="userInfo" class="text-sm text-slate-600 mb-2"></p>
          <button id="goDashboardBtn" class="w-full px-4 py-2 rounded-xl bg-emerald-600 text-white text-sm font-semibold">Go to Dashboard</button>
          <button id="logoutBtn" class="w-full px-4 py-2 rounded-xl border border-slate-300 text-slate-700 text-sm font-semibold">Log out</button>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow p-5 flex flex-col justify-center">
        <h2 class="text-lg font-semibold mb-2">How it works</h2>
        <ul class="text-sm text-slate-600 space-y-2">
            <li>• <b>Guests</b> can browse listings below without an account.</li>
            <li>• <b>Tenants</b> can create an account to chat with landlords.</li>
            <li>• <b>Landlords</b> can list properties and manage photos.</li>
        </ul>
        <p class="text-xs text-slate-400 mt-4">Active Listings are visible to search engines.</p>
      </div>
    </section>

    <section id="public-search" class="mb-6 bg-white rounded-2xl shadow p-5">
      <h2 class="text-lg font-semibold mb-3">Search rentals</h2>

      <div class="grid md:grid-cols-4 gap-3 mb-3 text-sm">
        <input id="filterCity" type="text" placeholder="City" class="px-3 py-2 border rounded-xl outline-none focus:ring-2 focus:ring-emerald-500" />
        <input id="filterMinPrice" type="number" placeholder="Min price" class="px-3 py-2 border rounded-xl outline-none focus:ring-2 focus:ring-emerald-500" />
        <input id="filterMaxPrice" type="number" placeholder="Max price" class="px-3 py-2 border rounded-xl outline-none focus:ring-2 focus:ring-emerald-500" />
        <label class="flex items-center gap-1 text-slate-700">
          <input id="filterActive" type="checkbox" checked disabled /> <span>Showing Active Only</span>
        </label>
      </div>

      <div class="flex gap-3 mb-4">
        <button id="applyFiltersBtn" class="px-4 py-2 rounded-xl bg-emerald-600 text-white text-sm font-semibold hover:bg-emerald-700 transition">Apply filters</button>
        <button id="resetFiltersBtn" class="px-4 py-2 rounded-xl border border-slate-300 text-slate-700 text-sm font-semibold hover:bg-slate-50 transition">Reset</button>
      </div>

      <div id="listingsContainer" class="grid md:grid-cols-3 gap-4 text-sm text-slate-700">
        Loading listings...
      </div>
    </section>
  </div>

<script>
  // Элементы Логина
  const loginEmailEl = document.getElementById("loginEmail");
  const loginPasswordEl = document.getElementById("loginPassword");
  const loginBtnEl = document.getElementById("loginBtn");
  const loginStatusEl = document.getElementById("loginStatus");
  const loginFormEl = document.getElementById("loginForm");
  const loggedInActionsEl = document.getElementById("loggedInActions");
  const userInfoEl = document.getElementById("userInfo");

  // Элементы Поиска
  const listingsContainer = document.getElementById("listingsContainer");
  const applyFiltersBtn = document.getElementById("applyFiltersBtn");
  const resetFiltersBtn = document.getElementById("resetFiltersBtn");

  window.addEventListener("load", async () => {
    // 1. Проверяем инициализацию
    if (!window.sb) {
      loginStatusEl.textContent = "Error: System not initialized. Check supabase.js";
      listingsContainer.textContent = "Error loading listings: System connection failed.";
      return;
    }
    
    // 2. Проверяем сессию
    checkSession();

    // 3. Загружаем объявления (Восстанавливаем показ на главной!)
    loadPublicListings();
  });

  // --- LOGIN LOGIC ---
  async function checkSession() {
    const { data: { user } } = await window.sb.auth.getUser();
    if (user) {
      const profile = await getCurrentProfile(); // из supabase.js
      showLoggedInUI(user, profile?.role);
    }
  }

  function showLoggedInUI(user, role) {
    loginFormEl.classList.add("hidden");
    loggedInActionsEl.classList.remove("hidden");
    userInfoEl.textContent = `Logged in as ${user.email} (${role || 'user'})`;

    document.getElementById("goDashboardBtn").onclick = () => {
      if (role === 'landlord') window.location.href = 'landlord.html';
      else window.location.href = 'tenant.html';
    };
    document.getElementById("logoutBtn").onclick = () => logout();
  }

  loginBtnEl.addEventListener("click", async () => {
    const email = loginEmailEl.value.trim();
    const password = loginPasswordEl.value;
    if (!email || !password) return;

    loginBtnEl.disabled = true;
    loginStatusEl.textContent = "Signing in...";
    
    const { data, error } = await window.sb.auth.signInWithPassword({ email, password });
    if (error) {
      loginStatusEl.textContent = error.message;
      loginStatusEl.className = "text-xs mt-1 text-red-600";
      loginBtnEl.disabled = false;
    } else {
      loginStatusEl.textContent = "Success!";
      checkSession();
    }
  });

  // --- SEARCH LOGIC (Для гостей) ---
  
  applyFiltersBtn.onclick = loadPublicListings;
  resetFiltersBtn.onclick = () => {
      document.getElementById("filterCity").value = "";
      document.getElementById("filterMinPrice").value = "";
      document.getElementById("filterMaxPrice").value = "";
      loadPublicListings();
  };

  async function loadPublicListings() {
      listingsContainer.innerHTML = '<p class="col-span-full text-slate-500">Loading...</p>';
      
      let query = window.sb
        .from("listing")
        .select("*")
        .eq("is_active", true) // Только активные для главной
        .order("created_at", { ascending: false });

      // Фильтры
      const city = document.getElementById("filterCity").value.trim();
      const minP = document.getElementById("filterMinPrice").value;
      const maxP = document.getElementById("filterMaxPrice").value;

      if (city) query = query.ilike("city", `%${city}%`);
      if (minP) query = query.gte("price_per_month", parseInt(minP));
      if (maxP) query = query.lte("price_per_month", parseInt(maxP));

      const { data, error } = await query;

      if (error) {
          console.error(error);
          listingsContainer.innerHTML = `<p class="col-span-full text-red-500">Error loading: ${error.message}</p>`;
          return;
      }

      if (!data || !data.length) {
          listingsContainer.innerHTML = '<p class="col-span-full text-slate-500">No active listings found.</p>';
          return;
      }

      listingsContainer.innerHTML = "";
      data.forEach(item => {
          const card = document.createElement("div");
          card.className = "border rounded-2xl p-3 flex flex-col gap-2 hover:bg-slate-50 transition cursor-pointer";
          // При клике на карточку переходим к деталям
          card.onclick = () => window.location.href = `listing-details.html?id=${item.id}`;

          const img = item.main_photo_url || "https://via.placeholder.com/160?text=No+Photo";
          
          card.innerHTML = `
             <div class="h-32 bg-slate-200 rounded-xl overflow-hidden mb-2">
                <img src="${img}" class="w-full h-full object-cover" alt="${item.title}">
             </div>
             <div class="font-bold text-slate-800 text-sm truncate">${item.title}</div>
             <div class="text-xs text-slate-500">${item.city}</div>
             <div class="text-emerald-700 font-bold text-sm">$${item.price_per_month}/mo</div>
          `;
          listingsContainer.appendChild(card);
      });
  }
</script>
</body>
</html>
