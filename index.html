<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rental marketplace</title>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>
</head>
<body class="bg-slate-100 min-h-screen">
  <div class="max-w-6xl mx-auto py-8 px-4">
    
    <header class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold text-slate-800">Rental marketplace</h1>
      <div class="flex gap-2">
        <a href="register.html" id="signupBtn" class="px-4 py-2 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700">Sign up</a>
      </div>
    </header>

    <section class="mb-6 grid md:grid-cols-[1.3fr,2fr] gap-4">
      <div class="bg-white rounded-2xl shadow p-5">
        <h2 class="text-lg font-semibold mb-3">Sign in</h2>
        
        <div id="loginForm" class="space-y-2">
          <input id="loginEmail" type="email" placeholder="Email" class="w-full px-3 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500" />
          <input id="loginPassword" type="password" placeholder="Password" class="w-full px-3 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500" />
          <button id="loginBtn" class="w-full px-4 py-2 bg-slate-800 text-white rounded-xl hover:bg-slate-900 transition">Log in</button>
          <p id="loginStatus" class="text-xs mt-1 text-slate-500"></p>
        </div>

        <div id="loggedInActions" class="hidden space-y-2">
          <p id="userInfo" class="text-sm text-slate-600 font-medium"></p>
          <button id="goDashboardBtn" class="w-full px-4 py-2 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 transition">Go to Dashboard</button>
          <button onclick="window.sb.logout()" class="w-full px-4 py-2 border border-slate-300 rounded-xl hover:bg-slate-50 transition">Log out</button>
        </div>
      </div>
      
      <div class="bg-white rounded-2xl shadow p-5 flex items-center justify-center text-slate-500 text-sm">
        <p>Log in to manage listings, chat, and save favorites.</p>
      </div>
    </section>

    <section id="search" class="bg-white rounded-2xl shadow p-5">
      <h2 class="text-lg font-semibold mb-3">Search rentals</h2>
      <div class="flex gap-2 mb-4">
        <input id="filterCity" type="text" placeholder="City (e.g. Moscow)" class="border rounded-xl px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-emerald-500">
        <button onclick="loadListings()" class="bg-emerald-600 text-white px-4 py-2 rounded-xl hover:bg-emerald-700 transition">Search</button>
      </div>
      <div id="listingsContainer" class="grid md:grid-cols-3 gap-4">
        <p class="text-gray-400">Loading...</p>
      </div>
    </section>
  </div>

<script>
  // Ждем полной загрузки DOM и скриптов
  window.addEventListener("load", async () => {
    // Защита: если window.sb не загрузился из-за ошибки в supabase.js
    if (!window.sb) {
        console.error("Supabase not initialized");
        return;
    }
    
    await checkSession();
    loadListings();
  });

  // Проверка текущей сессии
  async function checkSession() {
    // 1. Проверяем, есть ли пользователь в Auth (через .client)
    const { data: { user } } = await window.sb.client.auth.getUser();
    
    if (user) {
      // 2. Получаем профиль через наш хелпер (он же проверит бан)
      const profile = await window.sb.getCurrentProfile();
      
      // Если профиль вернулся (не забанен), показываем интерфейс
      if (profile) {
        showLoggedInUI(user, profile.role);
      }
    }
  }

  // Обновление UI при входе
  function showLoggedInUI(user, role) {
    document.getElementById("loginForm").classList.add("hidden");
    document.getElementById("loggedInActions").classList.remove("hidden");
    document.getElementById("signupBtn").classList.add("hidden"); // Скрываем кнопку регистрации
    
    document.getElementById("userInfo").textContent = `Hello, ${user.email} (${role})`;
    
    // Настраиваем кнопку перехода в дашборд
    const dashBtn = document.getElementById("goDashboardBtn");
    dashBtn.onclick = () => {
      if (role === 'admin') window.location.href = 'admin.html';
      else if (role === 'landlord') window.location.href = 'landlord.html';
      else window.location.href = 'tenant.html';
    };
  }

  // Обработчик кнопки входа
  document.getElementById("loginBtn").onclick = async () => {
    const email = document.getElementById("loginEmail").value;
    const password = document.getElementById("loginPassword").value;
    const status = document.getElementById("loginStatus");

    if(!email || !password) {
        status.textContent = "Please enter email and password";
        status.className = "text-xs mt-1 text-red-500";
        return;
    }

    status.textContent = "Signing in...";
    status.className = "text-xs mt-1 text-slate-500";

    // Используем наш хелпер window.sb.login
    const { data, error } = await window.sb.login(email, password);
    
    if (error) {
      status.textContent = error.message;
      status.className = "text-xs mt-1 text-red-600 font-bold";
    } else {
      status.textContent = "Success! Redirecting...";
      status.className = "text-xs mt-1 text-green-600 font-bold";
      
      // Получаем роль для редиректа
      const profile = await window.sb.getCurrentProfile();
      
      if (profile) {
          if (profile.role === 'admin') window.location.href = 'admin.html';
          else if (profile.role === 'landlord') window.location.href = 'landlord.html';
          else window.location.href = 'tenant.html';
      }
    }
  };

  // Загрузка объявлений (Публичный поиск)
  async function loadListings() {
    const city = document.getElementById("filterCity").value;
    const container = document.getElementById("listingsContainer");
    
    // Важно: доступ к базе через window.sb.client
    let query = window.sb.client
        .from("listing")
        .select("*")
        .eq("is_active", true)
        .order("created_at", {ascending: false});

    if(city) {
        query = query.ilike("city", `%${city}%`);
    }
    
    const { data, error } = await query;
    
    container.innerHTML = "";

    if (error) {
        container.innerHTML = `<p class="text-red-500">Error loading listings.</p>`;
        return;
    }
    
    if(!data || !data.length) { 
        container.innerHTML = `<p class="text-slate-500 col-span-3 text-center py-4">No active listings found.</p>`; 
        return; 
    }
    
    data.forEach(item => {
      const div = document.createElement("div");
      div.className = "bg-white border border-slate-200 rounded-xl p-3 cursor-pointer hover:shadow-lg transition duration-200";
      div.onclick = () => window.location.href = `listing-details.html?id=${item.id}`;
      
      // Защита от битых картинок
      const imgUrl = item.main_photo_url || 'https://via.placeholder.com/400x300?text=No+Photo';

      div.innerHTML = `
        <div class="relative h-48 w-full mb-3 overflow-hidden rounded-lg bg-gray-100">
            <img src="${imgUrl}" class="w-full h-full object-cover hover:scale-105 transition duration-3
