<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Landlord Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>
</head>
<body class="bg-slate-100 min-h-screen">

  <nav class="bg-white shadow mb-8 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex items-center gap-4">
          <h1 class="text-xl font-bold text-slate-800">Landlord Dashboard</h1>
          <span class="text-slate-300">|</span>
          <a href="tenant.html" class="flex items-center gap-2 text-sm text-slate-500 hover:text-emerald-600 transition font-medium">
            <span>üîç Find Home (Tenant View)</span>
          </a>
        </div>
        <div class="flex items-center gap-4">
          <span id="userEmail" class="text-sm text-slate-600 hidden sm:block"></span>
          <button id="logoutBtn" class="text-sm text-red-600 hover:text-red-800 font-medium">Log out</button>
        </div>
      </div>
    </div>
  </nav>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold text-slate-800">My Listings</h2>
      <button onclick="openModal()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-xl text-sm font-semibold shadow-sm">+ Create Listing</button>
    </div>

    <div class="mb-8 bg-white p-4 rounded-xl shadow-sm border border-slate-200">
      <h3 class="font-bold text-slate-700 mb-2">Recent Messages</h3>
      <div id="inboxPreview" class="text-sm text-slate-500">Loading messages...</div>
    </div>

    <div id="listingsContainer" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
      <div class="col-span-full text-center py-10 text-slate-500">Loading...</div>
    </div>
  </div>

  <div id="listingModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl w-full max-w-2xl relative shadow-2xl flex flex-col max-h-[90vh]">
      <div class="px-6 py-4 border-b flex justify-between items-center">
        <h3 id="modalTitle" class="font-bold text-slate-800">Edit Listing</h3>
        <button onclick="closeModal()" class="text-2xl text-slate-400 hover:text-slate-600">&times;</button>
      </div>
      <div class="p-6 overflow-y-auto space-y-4">
        <input type="hidden" id="inpId" />
        <input id="inpTitle" type="text" placeholder="Title" class="w-full px-3 py-2 border rounded-xl outline-none focus:ring-2 focus:ring-emerald-500" />
        <div class="grid grid-cols-2 gap-4">
           <input id="inpCity" type="text" placeholder="City" class="w-full px-3 py-2 border rounded-xl outline-none focus:ring-2 focus:ring-emerald-500" />
           <input id="inpPrice" type="number" placeholder="Price" class="w-full px-3 py-2 border rounded-xl outline-none focus:ring-2 focus:ring-emerald-500" />
        </div>
        <textarea id="inpDesc" rows="3" placeholder="Description" class="w-full px-3 py-2 border rounded-xl outline-none focus:ring-2 focus:ring-emerald-500"></textarea>
        
        <div class="flex gap-4 border-t pt-3">
           <label><input id="inpActive" type="checkbox"> Active</label>
           <label><input id="inpWifi" type="checkbox"> Wifi</label>
           <label><input id="inpPets" type="checkbox"> Pets</label>
           <label><input id="inpFurnished" type="checkbox"> Furnished</label>
        </div>

        <div class="border-t pt-3">
          <p class="text-xs font-bold text-slate-500 mb-2">PHOTOS (Save first to upload)</p>
          <div id="photosContainer" class="grid grid-cols-4 gap-2"></div>
        </div>
        <p id="modalStatus" class="text-center text-sm hidden"></p>
      </div>
      <div class="px-6 py-4 border-t bg-slate-50 rounded-b-2xl flex justify-end gap-2">
        <button onclick="closeModal()" class="px-4 py-2 border rounded-xl">Cancel</button>
        <button onclick="saveListing()" class="px-4 py-2 bg-emerald-600 text-white rounded-xl font-bold">Save</button>
      </div>
    </div>
  </div>

<script>
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º window.sb
  let currentUser = null;
  const BUCKET = 'listing-images';

  window.addEventListener('load', async () => {
    if(!window.sb) return;
    currentUser = await requireAuth();
    document.getElementById('userEmail').textContent = currentUser.email;
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏
    const profile = await getCurrentProfile();
    if (profile?.role !== 'landlord') window.location.href = 'tenant.html';

    loadListings();
    loadInboxPreview();
    document.getElementById('logoutBtn').onclick = logout;
  });

  async function loadListings() {
    const container = document.getElementById('listingsContainer');
    const { data, error } = await window.sb
      .from('listing')
      .select('*')
      .eq('owner_id', currentUser.id)
      .order('created_at', {ascending: false});

    if(error) { container.textContent = "Error loading"; return; }
    
    container.innerHTML = '';
    if(!data.length) container.textContent = "No listings.";

    data.forEach(item => {
      const card = document.createElement('div');
      card.className = "bg-white border rounded-xl overflow-hidden hover:shadow-lg transition cursor-pointer";
      card.onclick = () => openModal(item);
      card.innerHTML = `
        <div class="h-40 bg-slate-200">
          <img src="${item.main_photo_url || ''}" class="w-full h-full object-cover">
        </div>
        <div class="p-3">
          <div class="font-bold truncate">${item.title}</div>
          <div class="text-xs text-slate-500">$${item.price_per_month} ‚Ä¢ ${item.city}</div>
          <div class="mt-2 text-xs text-emerald-600 font-bold hover:underline" onclick="event.stopPropagation(); location.href='listing-details.html?id=${item.id}'">View Page & Chats</div>
        </div>
      `;
      container.appendChild(card);
    });
  }

  async function loadInboxPreview() {
    // –ì—Ä—É–∑–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    const { data } = await window.sb.from('messages').select('message, tenant_email, created_at').eq('is_read_by_landlord', false).limit(3);
    const box = document.getElementById('inboxPreview');
    if(data && data.length) {
       box.innerHTML = data.map(m => `<div class="border-b py-1 flex justify-between"><span>${m.tenant_email}: ${m.message.substring(0,20)}...</span><span class="text-xs text-red-500">New</span></div>`).join('');
    } else {
       box.textContent = "No new unread messages.";
    }
  }

  // --- CRUD & MODAL (Simplified for brevity but fully functional) ---
  const modal = document.getElementById('listingModal');
  const inpId = document.getElementById('inpId');
  
  window.openModal = function(item=null) {
    modal.classList.remove('hidden'); modal.classList.add('flex');
    if(item) {
      inpId.value = item.id;
      document.getElementById('inpTitle').value = item.title;
      document.getElementById('inpCity').value = item.city;
      document.getElementById('inpPrice').value = item.price_per_month;
      document.getElementById('inpDesc').value = item.description;
      document.getElementById('inpActive').checked = item.is_active;
      renderPhotos(item);
    } else {
      inpId.value = '';
      document.getElementById('inpTitle').value = '';
      document.getElementById('photosContainer').innerHTML = 'Save to upload photos';
    }
  }
  window.closeModal = () => { modal.classList.add('hidden'); modal.classList.remove('flex'); }

  window.saveListing = async function() {
    const payload = {
      owner_id: currentUser.id,
      title: document.getElementById('inpTitle').value,
      city: document.getElementById('inpCity').value,
      price_per_month: document.getElementById('inpPrice').value,
      description: document.getElementById('inpDesc').value,
      is_active: document.getElementById('inpActive').checked,
      has_wifi: document.getElementById('inpWifi').checked,
      allow_pets: document.getElementById('inpPets').checked,
      is_furnished: document.getElementById('inpFurnished').checked,
    };
    
    let res;
    if(inpId.value) res = await window.sb.from('listing').update(payload).eq('id', inpId.value).select().single();
    else res = await window.sb.from('listing').insert(payload).select().single();

    if(res.error) alert(res.error.message);
    else { openModal(res.data); loadListings(); }
  }

  function renderPhotos(item) {
    const c = document.getElementById('photosContainer');
    c.innerHTML = '';
    ['main_photo_url','photo2_url','photo3_url','photo4_url'].forEach(k => {
       const div = document.createElement('div');
       div.className = "h-16 bg-slate-100 border rounded flex items-center justify-center relative overflow-hidden";
       if(item[k]) {
         div.innerHTML = `<img src="${item[k]}" class="w-full h-full object-cover"><button onclick="deletePhoto('${k}','${item.id}')" class="absolute top-0 right-0 bg-red-600 text-white text-[10px] px-1">X</button>`;
       } else {
         div.innerHTML = `<span class="text-xl text-slate-400">+</span>`;
         div.onclick = () => uploadPhoto(k, item.id);
       }
       c.appendChild(div);
    });
  }

  // --- UPLOAD HELPERS ---
  const fileInp = document.createElement('input'); fileInp.type='file';
  let curField, curId;
  fileInp.onchange = async(e) => {
    if(!e.target.files[0]) return;
    const file = e.target.files[0];
    const path = `${currentUser.id}/${curId}/${Date.now()}_${file.name}`;
    await window.sb.storage.from(BUCKET).upload(path, file);
    const {data:{publicUrl}} = window.sb.storage.from(BUCKET).getPublicUrl(path);
    await window.sb.from('listing').update({[curField]: publicUrl}).eq('id', curId);
    // Refresh
    const {data} = await window.sb.from('listing').select('*').eq('id', curId).single();
    renderPhotos(data);
    loadListings();
  }
  function uploadPhoto(field, id) { curField=field; curId=id; fileInp.click(); }
  window.deletePhoto = async(field, id) => {
     if(!confirm('Delete?')) return;
     await window.sb.from('listing').update({[field]: null}).eq('id', id);
     const {data} = await window.sb.from('listing').select('*').eq('id', id).single();
     renderPhotos(data);
  }
</script>
</body>
</html>
