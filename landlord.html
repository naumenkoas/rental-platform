<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Landlord Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-100 min-h-screen">
  <div class="max-w-5xl mx-auto py-8 px-4">
    <header class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold text-slate-800">Landlord Dashboard</h1>
      <div class="flex items-center gap-3">
        <a href="tenant.html"
           class="px-4 py-2 rounded-xl border border-slate-300 text-slate-800 text-sm font-semibold hover:bg-slate-50 transition">
          Search listings
        </a>
        <button id="logoutBtn"
          class="px-4 py-2 rounded-xl bg-slate-800 text-white font-semibold hover:bg-slate-900 transition">
          Log out
        </button>
      </div>
    </header>

    <section class="mb-4">
      <p id="welcome" class="text-slate-700">Loading user data...</p>
      <p id="statusMessage" class="text-sm mt-1"></p>
    </section>

    <section class="mb-6">
      <div class="bg-white rounded-2xl shadow p-5">
        <h2 class="text-xl font-semibold mb-3 flex items-center gap-2">
          Inbox
          <span id="inboxCount" class="bg-emerald-100 text-emerald-800 text-xs font-semibold px-2 py-0.5 rounded-full hidden">0</span>
        </h2>
        <div id="inboxList" class="space-y-3 text-sm text-slate-700 max-h-64 overflow-y-auto">
          Loading messages...
        </div>
      </div>
    </section>

    <section class="grid md:grid-cols-2 gap-6">
      <div class="bg-white rounded-2xl shadow p-5">
        <h2 class="text-xl font-semibold mb-3">Add new listing</h2>
        <div class="space-y-2">
          <input id="title" type="text" placeholder="Title"
            class="w-full px-3 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500" />
          <input id="city" type="text" placeholder="City"
            class="w-full px-3 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500" />
          <input id="price" type="number" placeholder="Monthly price"
            class="w-full px-3 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500" />
          <input id="deposit" type="number" placeholder="Deposit amount (optional)"
            class="w-full px-3 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500" />
          <textarea id="description" placeholder="Description"
            class="w-full px-3 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500"></textarea>

          <div class="flex flex-wrap gap-3 text-sm text-slate-700">
            <label class="inline-flex items-center gap-1">
              <input id="has_wifi" type="checkbox" class="rounded border-slate-300" />
              <span>Wi-Fi</span>
            </label>
            <label class="inline-flex items-center gap-1">
              <input id="allow_pets" type="checkbox" class="rounded border-slate-300" />
              <span>Pets allowed</span>
            </label>
            <label class="inline-flex items-center gap-1">
              <input id="is_furnished" type="checkbox" class="rounded border-slate-300" />
              <span>Furnished</span>
            </label>
            <label class="inline-flex items-center gap-1">
              <input id="is_active" type="checkbox" class="rounded border-slate-300" checked />
              <span>Active</span>
            </label>
          </div>

          <div>
            <input id="photos" type="file" accept="image/*" multiple
              class="w-full px-3 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500" />
            <p class="text-xs text-slate-500 mt-1">
              You can select up to 4 images.
            </p>
          </div>

          <button id="createBtn"
            class="w-full px-4 py-2 rounded-xl bg-emerald-600 text-white font-semibold hover:bg-emerald-700 transition">
            Save listing
          </button>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow p-5">
        <h2 class="text-xl font-semibold mb-3">My listings</h2>
        <div id="myListings" class="space-y-3 text-sm text-slate-700">
          Loading...
        </div>
      </div>
    </section>
  </div>

<script>
  const supabaseUrl = "https://zzkriumjamchjrxdxhzf.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp6a3JpdW1qYW1jaGpyeGR4aHpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNDkyNDcsImV4cCI6MjA3OTgyNTI0N30.mK7jN6En9SWhr2Avt545CIGm58Kd7ACgs8hGOe4UKMU";
  const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

  let currentUser = null;

  function setStatus(text, isError = false) {
    const el = document.getElementById("statusMessage");
    if (!el) return;
    el.textContent = text || "";
    el.className = "text-sm mt-1 " + (isError ? "text-red-600" : "text-emerald-600");
  }

  function safeUUID() {
    return "img-" + Date.now() + "-" + Math.floor(Math.random() * 1000);
  }

  window.addEventListener("load", () => {
    init();
  });

  async function init() {
    // 1. Проверяем авторизацию
    const { data: { user }, error } = await supabase.auth.getUser();
    
    if (error || !user) {
      window.location.href = "index.html";
      return;
    }
    
    // 2. Проверяем РОЛЬ (защита от арендаторов)
    const { data: profile } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', user.id)
        .single();
        
    if (profile && profile.role !== 'landlord') {
        // Если ты не лендлорд — иди искать квартиры
        window.location.href = "tenant.html";
        return;
    }

    currentUser = user;
    document.getElementById("welcome").textContent = `Welcome, ${currentUser.email}`;

    // 3. Вешаем обработчик Logout
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      document.getElementById("logoutBtn").textContent = "Logging out...";
      await supabase.auth.signOut();
      window.location.href = "index.html";
    });

    // 4. Вешаем обработчик создания
    document.getElementById("createBtn").addEventListener("click", onCreateListing);

    // 5. Грузим данные
    loadMyListings();
    loadInbox();
  }

  // --- ЛОГИКА ЗАГРУЗКИ СООБЩЕНИЙ ---
  async function loadInbox() {
    const container = document.getElementById("inboxList");
    const countBadge = document.getElementById("inboxCount");
    
    const { data, error } = await supabase
      .from("messages")
      .select("*, listing(title, city)")
      .order("created_at", { ascending: false });

    if (error) {
      console.error("Inbox error", error);
      container.textContent = "Error loading messages.";
      return;
    }

    if (!data || data.length === 0) {
      container.textContent = "No messages yet.";
      return;
    }

    if (countBadge) {
      countBadge.textContent = data.length;
      countBadge.classList.remove("hidden");
    }
    container.innerHTML = "";
    
    data.forEach(msg => {
      const div = document.createElement("div");
      div.className = "border-b last:border-0 pb-3 mb-3 hover:bg-slate-50 p-2 rounded transition";
      const listingTitle = msg.listing ? `${msg.listing.title}` : "Unknown listing";
      div.innerHTML = `
        <div class="flex justify-between mb-1">
           <span class="font-bold text-xs text-emerald-700 uppercase">${listingTitle}</span>
           <span class="text-xs text-slate-400">${new Date(msg.created_at).toLocaleDateString()}</span>
        </div>
        <div class="font-medium text-sm mb-1">From: ${msg.tenant_email || "Guest"}</div>
        <div class="text-slate-600 bg-slate-50 p-2 rounded text-sm italic border">${msg.message}</div>
      `;
      container.appendChild(div);
    });
  }

  // --- ЛОГИКА ЗАГРУЗКИ ФОТО ---
  async function uploadPhotos(files) {
    const urls = [null, null, null, null];
    const max = Math.min(files.length, 4);

    for (let i = 0; i < max; i++) {
      const file = files[i];
      const ext = file.name.split('.').pop();
      const fileName = `${currentUser.id}/${safeUUID()}.${ext}`;

      // Upload
      const { error: upErr } = await supabase.storage
        .from('listing-photos')
        .upload(fileName, file);

      if (upErr) {
        console.error("Upload failed", upErr);
        throw upErr;
      }

      // Get URL
      const { data: pubData } = supabase.storage
        .from('listing-photos')
        .getPublicUrl(fileName);
        
      urls[i] = pubData.publicUrl;
    }
    return urls;
  }

  // --- ЛОГИКА СОЗДАНИЯ ОБЪЯВЛЕНИЯ ---
  async function onCreateListing() {
    setStatus("");
    const btn = document.getElementById("createBtn");
    
    // Сбор данных
    const title = document.getElementById("title").value.trim();
    const city = document.getElementById("city").value.trim();
    const price = document.getElementById("price").value;
    const deposit = document.getElementById("deposit").value;
    const desc = document.getElementById("description").value;
    const files = document.getElementById("photos").files;

    if (!title || !city || !price) {
        setStatus("Title, City and Price are required!", true);
        return;
    }

    btn.disabled = true;
    btn.textContent = "Saving...";

    try {
        // 1. Грузим фото (если есть)
        let urls = [null, null, null, null];
        if (files.length > 0) {
            setStatus("Uploading photos...");
            urls = await uploadPhotos(files);
        }

        // 2. Пишем в БД
        setStatus("Saving data...");
        const { error } = await supabase.from('listing').insert([{
            owner_id: currentUser.id,
            title: title,
            city: city,
            price_per_month: parseInt(price),
            deposit_amount: deposit ? parseInt(deposit) : null,
            description: desc,
            has_wifi: document.getElementById("has_wifi").checked,
            allow_pets: document.getElementById("allow_pets").checked,
            is_furnished: document.getElementById("is_furnished").checked,
            is_active: document.getElementById("is_active").checked,
            main_photo_url: urls[0],
            photo2_url: urls[1],
            photo3_url: urls[2],
            photo4_url: urls[3]
        }]);

        if (error) throw error;

        setStatus("Success! Listing created.");
        // Чистим форму
        document.getElementById("title").value = "";
        document.getElementById("city").value = "";
        document.getElementById("price").value = "";
        document.getElementById("description").value = "";
        document.getElementById("photos").value = "";
        loadMyListings();

    } catch (e) {
        console.error(e);
        setStatus("Error: " + e.message, true);
    } finally {
        btn.disabled = false;
        btn.textContent = "Save listing";
    }
  }

  // --- СПИСОК МОИХ ОБЪЯВЛЕНИЙ ---
  async function loadMyListings() {
    const container = document.getElementById("myListings");
    const { data, error } = await supabase
        .from('listing')
        .select('*')
        .eq('owner_id', currentUser.id)
        .order('created_at', { ascending: false });

    if (error) {
        container.textContent = "Error loading listings";
        return;
    }
    if (!data.length) {
        container.textContent = "No listings yet.";
        return;
    }

    container.innerHTML = "";
    data.forEach(item => {
        const div = document.createElement("div");
        div.className = "flex gap-3 border p-2 rounded-xl mb-2 items-center hover:bg-slate-50 cursor-pointer";
        const img = item.main_photo_url || "https://via.placeholder.com/60";
        div.innerHTML = `
            <img src="${img}" class="w-12 h-12 rounded bg-slate-200 object-cover">
            <div>
                <div class="font-bold text-sm">${item.title}</div>
                <div class="text-xs text-slate-500">$${item.price_per_month} • ${item.city}</div>
            </div>
        `;
        div.onclick = () => window.location.href = `listing-details.html?id=${item.id}`;
        container.appendChild(div);
    });
  }
</script>
</body>
</html>
