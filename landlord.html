-- 1. Сначала удалим старые политики на SELECT (чтобы не конфликтовали)
DROP POLICY IF EXISTS "Enable read access for authenticated users" ON messages;
DROP POLICY IF EXISTS "Public can insert messages" ON messages; 

-- 2. Разрешаем ВСТАВКУ (INSERT) для всех (включая анонимов, как в ТЗ)
CREATE POLICY "Public can insert messages"
ON messages FOR INSERT
TO public
WITH CHECK (true);

-- 3. Разрешаем ЧТЕНИЕ (SELECT) только владельцам объявлений
-- Логика: "Я могу прочитать сообщение, если я залогинен И (я являюсь владельцем объявления, на которое ссылается это сообщение)"
CREATE POLICY "Landlords view messages for their listings"
ON messages FOR SELECT
TO authenticated
USING (
  exists (
    select 1 from listing
    where listing.id = messages.listing_id
    and listing.owner_id = auth.uid()
  )
);
