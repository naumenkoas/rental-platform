<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Landlord Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>
</head>
<body class="bg-slate-100 min-h-screen">
  <div class="max-w-6xl mx-auto py-8 px-4">
    <header class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold text-slate-800">Landlord Dashboard</h1>
      <div class="flex items-center gap-3">
        <a href="listing.html"
           class="px-4 py-2 rounded-xl border border-slate-300 text-slate-800 text-sm font-semibold hover:bg-slate-50 transition">
          Public listings
        </a>
        <a href="tenant.html"
           class="px-4 py-2 rounded-xl border border-slate-300 text-slate-800 text-sm font-semibold hover:bg-slate-50 transition">
          Tenant search
        </a>
        <button id="logoutBtn"
          class="px-4 py-2 rounded-xl bg-slate-800 text-white font-semibold hover:bg-slate-900 transition">
          Log out
        </button>
      </div>
    </header>

    <section class="mb-4">
      <p id="welcome" class="text-slate-700">Loading user data...</p>
      <p id="statusMessage" class="text-sm mt-1"></p>
    </section>

    <!-- INBOX ДИАЛОГОВ -->
    <section class="mb-6">
      <div class="bg-white rounded-2xl shadow p-5">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-3">
            <h2 class="text-xl font-semibold flex items-center gap-2">
              Inbox
              <span id="inboxCount"
                    class="bg-emerald-100 text-emerald-800 text-xs font-semibold px-2 py-0.5 rounded-full hidden">
                0
              </span>
            </h2>
            <label class="flex items-center gap-1 text-xs text-slate-600">
              <input type="checkbox" id="showHiddenCheckbox" class="rounded border-slate-300" />
              <span>Show hidden conversations</span>
            </label>
          </div>
          <button id="refreshInboxBtn"
            class="text-xs px-3 py-1 rounded-full border border-slate-300 text-slate-600 hover:bg-slate-50">
            Refresh
          </button>
        </div>
        <div id="inboxList"
             class="space-y-3 text-sm text-slate-700 max-h-80 overflow-y-auto">
          Loading messages...
        </div>
      </div>
    </section>

    <!-- СОЗДАНИЕ + СПИСОК ОБЪЯВЛЕНИЙ -->
    <section class="grid md:grid-cols-2 gap-6">
      <!-- СОЗДАНИЕ -->
      <div class="bg-white rounded-2xl shadow p-5">
        <h2 class="text-xl font-semibold mb-3">Add new listing</h2>
        <div class="space-y-2">
          <input id="title" type="text" placeholder="Title"
            class="w-full px-3 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500" />
          <input id="city" type="text" placeholder="City"
            class="w-full px-3 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500" />
          <input id="price" type="number" placeholder="Monthly price"
            class="w-full px-3 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500" />
          <input id="deposit" type="number" placeholder="Deposit amount (optional)"
            class="w-full px-3 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500" />
          <textarea id="description" placeholder="Description"
            class="w-full px-3 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500"></textarea>

          <div class="flex flex-wrap gap-3 text-sm text-slate-700">
            <label class="inline-flex items-center gap-1">
              <input id="has_wifi" type="checkbox" class="rounded border-slate-300" />
              <span>Wi-Fi</span>
            </label>
            <label class="inline-flex items-center gap-1">
              <input id="allow_pets" type="checkbox" class="rounded border-slate-300" />
              <span>Pets allowed</span>
            </label>
            <label class="inline-flex items-center gap-1">
              <input id="is_furnished" type="checkbox" class="rounded border-slate-300" />
              <span>Furnished</span>
            </label>
            <label class="inline-flex items-center gap-1">
              <input id="is_active" type="checkbox" class="rounded border-slate-300" checked />
              <span>Active</span>
            </label>
          </div>

          <div>
            <input id="photos" type="file" accept="image/*" multiple
              class="w-full px-3 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500" />
            <p class="text-xs text-slate-500 mt-1">
              You can select up to 4 images at once. Later you can edit them one by one.
            </p>
          </div>

          <button id="createBtn"
            class="w-full px-4 py-2 rounded-xl bg-emerald-600 text-white font-semibold hover:bg-emerald-700 transition">
            Save listing
          </button>
        </div>
      </div>

      <!-- СПИСОК ОБЪЯВЛЕНИЙ -->
      <div class="bg-white rounded-2xl shadow p-5">
        <h2 class="text-xl font-semibold mb-3">My listings</h2>
        <div id="myListings" class="space-y-3 text-sm text-slate-700">
          Loading...
        </div>
      </div>
    </section>

    <!-- РЕДАКТИРОВАНИЕ ОБЪЯВЛЕНИЯ -->
    <section id="editSection" class="mt-6 hidden">
      <div class="bg-white rounded-2xl shadow p-5">
        <div class="flex justify-between items-center mb-3">
          <h2 class="text-xl font-semibold">Edit listing</h2>
          <button id="cancelEditBtn"
            class="text-xs px-3 py-1 rounded-full border border-slate-300 text-slate-600 hover:bg-slate-50">
            Cancel
          </button>
        </div>
        <div class="space-y-2">
          <input id="edit_title" type="text" placeholder="Title"
            class="w-full px-3 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500" />
          <input id="edit_city" type="text" placeholder="City"
            class="w-full px-3 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500" />
          <input id="edit_price" type="number" placeholder="Monthly price"
            class="w-full px-3 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500" />
          <input id="edit_deposit" type="number" placeholder="Deposit amount (optional)"
            class="w-full px-3 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500" />
          <textarea id="edit_description" placeholder="Description"
            class="w-full px-3 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500"></textarea>

          <div class="flex flex-wrap gap-3 text-sm text-slate-700">
            <label class="inline-flex items-center gap-1">
              <input id="edit_has_wifi" type="checkbox" class="rounded border-slate-300" />
              <span>Wi-Fi</span>
            </label>
            <label class="inline-flex items-center gap-1">
              <input id="edit_allow_pets" type="checkbox" class="rounded border-slate-300" />
              <span>Pets allowed</span>
            </label>
            <label class="inline-flex items-center gap-1">
              <input id="edit_is_furnished" type="checkbox" class="rounded border-slate-300" />
              <span>Furnished</span>
            </label>
            <label class="inline-flex items-center gap-1">
              <input id="edit_is_active" type="checkbox" class="rounded border-slate-300" />
              <span>Active</span>
            </label>
          </div>

          <div>
            <h3 class="text-sm font-semibold mb-1">Photos (edit one by one)</h3>
            <div id="editPhotosContainer" class="grid grid-cols-2 gap-3 text-xs"></div>
            <p class="text-[11px] text-slate-500 mt-1">
              You can replace or remove each photo separately. Changes apply after you click “Save changes”.
            </p>
          </div>

          <button id="saveEditBtn"
            class="w-full px-4 py-2 rounded-xl bg-blue-600 text-white font-semibold hover:bg-blue-700 transition">
            Save changes
          </button>
        </div>
      </div>
    </section>
  </div>

<script>
  let currentUser = null;
  let editingListingId = null;
  let editingPhotos = [null, null, null, null]; // для edit

  let showHiddenConversations = false; // чекбокс в инбоксе

  function setStatus(text, isError = false) {
    const el = document.getElementById("statusMessage");
    if (!el) return;
    el.textContent = text || "";
    el.className =
      "text-sm mt-1 " + (isError ? "text-red-600" : "text-emerald-600");
  }

  function safeUUID() {
    return "img-" + Date.now() + "-" + Math.floor(Math.random() * 100000);
  }

  // Вытаскиваем путь внутри bucket'а из public URL
  function extractStoragePathFromPublicUrl(publicUrl) {
    try {
      const url = new URL(publicUrl);
      const marker = "/storage/v1/object/public/listing-photos/";
      const idx = url.pathname.indexOf(marker);
      if (idx === -1) return null;
      return url.pathname.substring(idx + marker.length);
    } catch (e) {
      console.error("extractStoragePath error", e);
      return null;
    }
  }

  async function removePhotoFromStorage(publicUrl) {
    const path = extractStoragePathFromPublicUrl(publicUrl);
    if (!path) return;
    const { error } = await supabase
      .storage
      .from("listing-photos")
      .remove([path]);
    if (error) {
      console.error("Storage remove error", error);
    }
  }

  window.addEventListener("load", () => {
    init();
  });

  async function init() {
    // Проверка auth + роль
    const { data, error } = await supabase.auth.getUser();
    if (error || !data || !data.user) {
      window.location.href = "index.html";
      return;
    }
    const user = data.user;

    const { data: profile, error: pErr } = await supabase
      .from("profiles")
      .select("role")
      .eq("id", user.id)
      .maybeSingle();

    if (pErr || !profile || profile.role !== "landlord") {
      window.location.href = "tenant.html";
      return;
    }

    currentUser = user;
    document.getElementById("welcome").textContent =
      `Welcome, ${currentUser.email}`;

    document.getElementById("logoutBtn").addEventListener("click", async () => {
      document.getElementById("logoutBtn").textContent = "Logging out...";
      await logout("index.html");
    });

    document.getElementById("createBtn")
      .addEventListener("click", onCreateListing);

    document.getElementById("refreshInboxBtn")
      .addEventListener("click", loadInboxThreads);

    document.getElementById("cancelEditBtn")
      .addEventListener("click", () => {
        editingListingId = null;
        document.getElementById("editSection").classList.add("hidden");
      });

    document.getElementById("saveEditBtn")
      .addEventListener("click", saveEditListing);

    document
      .getElementById("showHiddenCheckbox")
      .addEventListener("change", (e) => {
        showHiddenConversations = e.target.checked;
        loadInboxThreads();
      });

    loadMyListings();
    loadInboxThreads();
  }

  // ---------- INBOX: диалоги (с показом скрытых) ----------

  async function loadInboxThreads() {
    const container = document.getElementById("inboxList");
    const countBadge = document.getElementById("inboxCount");
    container.textContent = "Loading messages...";

    const { data, error } = await supabase
      .from("messages")
      .select(`
        id,
        created_at,
        message,
        tenant_id,
        tenant_email,
        is_from_landlord,
        is_read_by_landlord,
        hidden_for_landlord,
        listing_id,
        listing (
          title,
          city
        )
      `)
      // RLS уже ограничивает только на твои listing'и
      .order("created_at", { ascending: false });

    if (error) {
      console.error("Inbox error", error);
      container.textContent = error.message || "Error loading messages.";
      if (countBadge) countBadge.classList.add("hidden");
      return;
    }

    if (!data || data.length === 0) {
      container.textContent = "No messages yet.";
      if (countBadge) countBadge.classList.add("hidden");
      return;
    }

    const threadsMap = new Map();

    data.forEach(msg => {
      const listingId = msg.listing_id;
      const tenantKey =
        msg.tenant_id || ("email:" + (msg.tenant_email || "guest"));
      const key = `${listingId}|${tenantKey}`;

      let thread = threadsMap.get(key);
      if (!thread) {
        thread = {
          listing_id: listingId,
          listing: msg.listing || { title: "(no title)", city: "" },
          tenant_id: msg.tenant_id || null,
          tenant_email: msg.tenant_email || "",
          messages: [],
        };
        threadsMap.set(key, thread);
      }
      thread.messages.push(msg);
    });

    const threads = Array.from(threadsMap.values())
      .map(thread => {
        const msgs = thread.messages;
        msgs.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
        const last = msgs[msgs.length - 1];

        const nonHidden = msgs.filter(m => !m.hidden_for_landlord);
        const allHidden = nonHidden.length === 0;

        const unreadCount = msgs.filter(
          m => !m.is_from_landlord && !m.is_read_by_landlord && !m.hidden_for_landlord
        ).length;

        return {
          ...thread,
          lastMessageAt: last.created_at,
          lastMessageText: last.message || "",
          unreadCount,
          allHidden,
        };
      })
      .sort((a, b) => new Date(b.lastMessageAt) - new Date(a.lastMessageAt));

    container.innerHTML = "";

    const totalUnread = threads.reduce(
      (acc, t) => acc + (t.allHidden ? 0 : t.unreadCount),
      0
    );
    if (countBadge) {
      if (totalUnread > 0) {
        countBadge.textContent = totalUnread;
        countBadge.classList.remove("hidden");
      } else {
        countBadge.classList.add("hidden");
      }
    }

    let visibleThreads = threads;
    if (!showHiddenConversations) {
      visibleThreads = threads.filter(t => !t.allHidden);
    }

    if (!visibleThreads.length) {
      container.textContent = showHiddenConversations
        ? "Only hidden conversations exist. Turn off the filter or unhide some."
        : "No active conversations.";
      return;
    }

    visibleThreads.forEach(thread => {
      const div = document.createElement("div");
      const hiddenBadge = thread.allHidden
        ? '<span class="ml-2 bg-slate-200 text-slate-600 text-[10px] font-semibold px-2 py-0.5 rounded-full">Hidden</span>'
        : "";

      const unreadBadge =
        !thread.allHidden && thread.unreadCount
          ? `<span class="ml-2 bg-rose-100 text-rose-700 text-[10px] font-semibold px-2 py-0.5 rounded-full">${thread.unreadCount} new</span>`
          : "";

      const title = thread.listing.title || "(no title)";
      const city = thread.listing.city || "";
      const email =
        thread.tenant_email ||
        (thread.tenant_id ? "(registered tenant)" : "(guest)");

      const dt = new Date(thread.lastMessageAt).toLocaleString();

      const params = new URLSearchParams();
      params.set("id", thread.listing_id);
      if (thread.tenant_id) {
        params.set("tenant_id", thread.tenant_id);
      } else if (thread.tenant_email) {
        params.set("tenant_email", thread.tenant_email);
      }

      const chatUrl = `listing-details.html?${params.toString()}`;

      div.className =
        "border rounded-xl p-3 flex flex-col gap-1 hover:bg-slate-50 transition";

      div.innerHTML = `
        <div class="flex justify-between items-center">
          <div class="font-semibold text-sm">
            ${title} — ${city}
            ${unreadBadge}
            ${hiddenBadge}
          </div>
          <div class="text-[11px] text-slate-400">${dt}</div>
        </div>
        <div class="text-xs text-slate-500 mb-1">
          Tenant: ${email}
        </div>
        <div class="text-xs text-slate-700 line-clamp-2 mb-2">
          ${thread.lastMessageText || ""}
        </div>
        <div class="flex justify-end gap-2">
          <button class="px-3 py-1 text-xs rounded-full border border-slate-300 text-slate-700 hover:bg-slate-100"
                  data-action="open">
            Open chat
          </button>
          ${
            thread.allHidden
              ? `<button class="px-3 py-1 text-xs rounded-full border border-emerald-300 text-emerald-700 hover:bg-emerald-50"
                          data-action="unhide">
                   Unhide
                 </button>`
              : `<button class="px-3 py-1 text-xs rounded-full border border-amber-300 text-amber-700 hover:bg-amber-50"
                          data-action="hide">
                   Hide
                 </button>`
          }
        </div>
      `;

      div.querySelector('[data-action="open"]').addEventListener("click", () => {
        window.location.href = chatUrl;
      });

      const hideBtn = div.querySelector('[data-action="hide"]');
      const unhideBtn = div.querySelector('[data-action="unhide"]');

      if (hideBtn) {
        hideBtn.addEventListener("click", () => setThreadHidden(thread, true));
      }
      if (unhideBtn) {
        unhideBtn.addEventListener("click", () => setThreadHidden(thread, false));
      }

      container.appendChild(div);
    });
  }

  async function setThreadHidden(thread, hidden) {
    const confirmText = hidden
      ? "Hide this conversation from your inbox?"
      : "Show this conversation again in your inbox?";
    if (!confirm(confirmText)) return;

    let query = supabase
      .from("messages")
      .update({ hidden_for_landlord: hidden })
      .eq("listing_id", thread.listing_id);

    if (thread.tenant_id) {
      query = query.eq("tenant_id", thread.tenant_id);
    } else if (thread.tenant_email) {
      query = query.eq("tenant_email", thread.tenant_email);
    }

    const { error } = await query;
    if (error) {
      console.error("setThreadHidden error", error);
      alert(error.message || "Failed to update conversation visibility.");
      return;
    }
    loadInboxThreads();
  }

  // ---------- ЗАГРУЗКА ФОТО ПРИ СОЗДАНИИ ----------

  async function uploadPhotos(files) {
    const urls = [null, null, null, null];
    const max = Math.min(files.length, 4);

    for (let i = 0; i < max; i++) {
      const file = files[i];
      const extParts = file.name.split(".");
      const ext = extParts.length > 1 ? extParts.pop() : "jpg";
      const fileName = `${currentUser.id}/${safeUUID()}.${ext}`;

      const { error: upErr } = await supabase.storage
        .from("listing-photos")
        .upload(fileName, file);

      if (upErr) {
        console.error("Upload failed", upErr);
        throw upErr;
      }

      const { data: pubData } = supabase.storage
        .from("listing-photos")
        .getPublicUrl(fileName);

      urls[i] = pubData.publicUrl;
    }
    return urls;
  }

  async function uploadSinglePhoto(file) {
    const extParts = file.name.split(".");
    const ext = extParts.length > 1 ? extParts.pop() : "jpg";
    const fileName = `${currentUser.id}/${safeUUID()}.${ext}`;

    const { error: upErr } = await supabase.storage
      .from("listing-photos")
      .upload(fileName, file);

    if (upErr) {
      console.error("Upload single failed", upErr);
      throw upErr;
    }

    const { data: pubData } = supabase.storage
      .from("listing-photos")
      .getPublicUrl(fileName);

    return pubData.publicUrl;
  }

  // ---------- СОЗДАНИЕ ОБЪЯВЛЕНИЯ ----------

  async function onCreateListing() {
    setStatus("");
    const btn = document.getElementById("createBtn");

    const title = document.getElementById("title").value.trim();
    const city = document.getElementById("city").value.trim();
    const priceVal = document.getElementById("price").value;
    const depositVal = document.getElementById("deposit").value;
    const desc = document.getElementById("description").value;
    const files = document.getElementById("photos").files;

    if (!title || !city || !priceVal) {
      setStatus("Title, City and Price are required!", true);
      return;
    }

    const price_per_month = parseInt(priceVal, 10);
    const deposit_amount = depositVal ? parseInt(depositVal, 10) : null;

    if (Number.isNaN(price_per_month)) {
      setStatus("Monthly price must be a number.", true);
      return;
    }
    if (depositVal && Number.isNaN(deposit_amount)) {
      setStatus("Deposit must be a number.", true);
      return;
    }

    btn.disabled = true;
    btn.textContent = "Saving...";

    try {
      let urls = [null, null, null, null];
      if (files && files.length > 0) {
        setStatus("Uploading photos...");
        urls = await uploadPhotos(files);
      }

      setStatus("Saving data...");
      const { error } = await supabase.from("listing").insert([
        {
          owner_id: currentUser.id,
          title,
          city,
          price_per_month,
          deposit_amount,
          description: desc,
          has_wifi: document.getElementById("has_wifi").checked,
          allow_pets: document.getElementById("allow_pets").checked,
          is_furnished: document.getElementById("is_furnished").checked,
          is_active: document.getElementById("is_active").checked,
          main_photo_url: urls[0],
          photo2_url: urls[1],
          photo3_url: urls[2],
          photo4_url: urls[3],
        },
      ]);

      if (error) throw error;

      setStatus("Success! Listing created.");

      document.getElementById("title").value = "";
      document.getElementById("city").value = "";
      document.getElementById("price").value = "";
      document.getElementById("deposit").value = "";
      document.getElementById("description").value = "";
      document.getElementById("photos").value = "";
      document.getElementById("has_wifi").checked = false;
      document.getElementById("allow_pets").checked = false;
      document.getElementById("is_furnished").checked = false;
      document.getElementById("is_active").checked = true;

      loadMyListings();
    } catch (e) {
      console.error(e);
      setStatus("Error: " + (e.message || e), true);
    } finally {
      btn.disabled = false;
      btn.textContent = "Save listing";
    }
  }

  // ---------- СПИСОК ОБЪЯВЛЕНИЙ ----------

  async function loadMyListings() {
    const container = document.getElementById("myListings");
    container.textContent = "Loading...";

    const { data, error } = await supabase
      .from("listing")
      .select("*")
      .eq("owner_id", currentUser.id)
      .order("created_at", { ascending: false });

    if (error) {
      console.error("loadMyListings error", error);
      container.textContent = "Error loading listings";
      return;
    }

    if (!data || !data.length) {
      container.textContent = "No listings yet.";
      return;
    }

    container.innerHTML = "";
    data.forEach(item => {
      const div = document.createElement("div");
      div.className =
        "flex gap-3 border p-3 rounded-xl mb-2 items-center hover:bg-slate-50";

      const img = item.main_photo_url || "https://via.placeholder.com/60";

      const activeBadge = item.is_active !== false
        ? '<span class="text-[10px] px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-700">Active</span>'
        : '<span class="text-[10px] px-2 py-0.5 rounded-full bg-slate-200 text-slate-600">Inactive</span>';

      div.innerHTML = `
        <img src="${img}" class="w-12 h-12 rounded bg-slate-200 object-cover">
        <div class="flex-1">
          <div class="flex items-center gap-2">
            <div class="font-bold text-sm">${item.title}</div>
            ${activeBadge}
          </div>
          <div class="text-xs text-slate-500">
            $${item.price_per_month} • ${item.city}
          </div>
        </div>
        <div class="flex flex-col gap-1 text-xs">
          <button class="px-3 py-1 rounded-full border border-slate-300 text-slate-700 hover:bg-slate-100"
                  data-action="view">
            View
          </button>
          <button class="px-3 py-1 rounded-full border border-blue-300 text-blue-700 hover:bg-blue-50"
                  data-action="edit">
            Edit
          </button>
          <button class="px-3 py-1 rounded-full border border-amber-300 text-amber-700 hover:bg-amber-50"
                  data-action="toggle">
            ${item.is_active !== false ? "Deactivate" : "Activate"}
          </button>
          <button class="px-3 py-1 rounded-full border border-red-300 text-red-700 hover:bg-red-50"
                  data-action="delete">
            Delete
          </button>
        </div>
      `;

      div.querySelector('[data-action="view"]').addEventListener("click", () => {
        window.location.href = `listing-details.html?id=${item.id}`;
      });

      div.querySelector('[data-action="edit"]').addEventListener("click", () => {
        startEditListing(item);
      });

      div.querySelector('[data-action="toggle"]').addEventListener("click", () => {
        toggleListingActive(item);
      });

      div.querySelector('[data-action="delete"]').addEventListener("click", () => {
        deleteListing(item);
      });

      container.appendChild(div);
    });
  }

  function startEditListing(item) {
    editingListingId = item.id;

    document.getElementById("edit_title").value = item.title || "";
    document.getElementById("edit_city").value = item.city || "";
    document.getElementById("edit_price").value =
      item.price_per_month != null ? item.price_per_month : "";
    document.getElementById("edit_deposit").value =
      item.deposit_amount != null ? item.deposit_amount : "";
    document.getElementById("edit_description").value =
      item.description || "";
    document.getElementById("edit_has_wifi").checked = !!item.has_wifi;
    document.getElementById("edit_allow_pets").checked = !!item.allow_pets;
    document.getElementById("edit_is_furnished").checked = !!item.is_furnished;
    document.getElementById("edit_is_active").checked = item.is_active !== false;

    editingPhotos = [
      item.main_photo_url || null,
      item.photo2_url || null,
      item.photo3_url || null,
      item.photo4_url || null,
    ];

    renderEditPhotos();

    document.getElementById("editSection").classList.remove("hidden");
    window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
  }

  function renderEditPhotos() {
    const container = document.getElementById("editPhotosContainer");
    container.innerHTML = "";

    const labels = ["Main", "Photo 2", "Photo 3", "Photo 4"];

    editingPhotos.forEach((url, index) => {
      const slot = document.createElement("div");
      slot.className =
        "border rounded-xl p-2 flex flex-col items-center gap-1 bg-slate-50";

      const img = document.createElement("img");
      img.className = "w-24 h-24 rounded object-cover bg-slate-200";
      img.src = url || "https://via.placeholder.com/96x96?text=No+photo";
      img.alt = labels[index];

      const label = document.createElement("div");
      label.className = "text-[11px] text-slate-600";
      label.textContent = labels[index];

      const btnRow = document.createElement("div");
      btnRow.className = "flex gap-2 mt-1";

      const replaceBtn = document.createElement("button");
      replaceBtn.className =
        "px-2 py-1 text-[11px] rounded-full border border-slate-300 text-slate-700 hover:bg-slate-100";
      replaceBtn.textContent = "Replace";

      const removeBtn = document.createElement("button");
      removeBtn.className =
        "px-2 py-1 text-[11px] rounded-full border border-red-300 text-red-700 hover:bg-red-50";
      removeBtn.textContent = "Remove";

      const fileInput = document.createElement("input");
      fileInput.type = "file";
      fileInput.accept = "image/*";
      fileInput.className = "hidden";

      replaceBtn.addEventListener("click", () => fileInput.click());
      fileInput.addEventListener("change", async (event) => {
        const file = event.target.files[0];
        if (!file) return;
        try {
          setStatus("Uploading photo...");
          const newUrl = await uploadSinglePhoto(file);
          editingPhotos[index] = newUrl;
          renderEditPhotos();
          setStatus("Photo updated.");
        } catch (e) {
          console.error("upload single error", e);
          setStatus("Failed to upload photo.", true);
        }
      });

      removeBtn.addEventListener("click", async () => {
        if (!confirm("Remove this photo from listing?")) return;
        const oldUrl = editingPhotos[index];
        editingPhotos[index] = null;
        renderEditPhotos();
        if (oldUrl) {
          try {
            await removePhotoFromStorage(oldUrl);
          } catch (e) {
            console.error("removePhotoFromStorage error", e);
            setStatus("Failed to delete photo from storage.", true);
          }
        }
      });

      btnRow.appendChild(replaceBtn);
      btnRow.appendChild(removeBtn);

      slot.appendChild(img);
      slot.appendChild(label);
      slot.appendChild(btnRow);
      slot.appendChild(fileInput);

      container.appendChild(slot);
    });
  }

  async function saveEditListing() {
    if (!editingListingId) return;

    const payload = {
      title: document.getElementById("edit_title").value.trim(),
      city: document.getElementById("edit_city").value.trim(),
      price_per_month:
        parseInt(document.getElementById("edit_price").value, 10) || null,
      deposit_amount: document.getElementById("edit_deposit").value
        ? parseInt(document.getElementById("edit_deposit").value, 10)
        : null,
      description: document.getElementById("edit_description").value,
      has_wifi: document.getElementById("edit_has_wifi").checked,
      allow_pets: document.getElementById("edit_allow_pets").checked,
      is_furnished: document.getElementById("edit_is_furnished").checked,
      is_active: document.getElementById("edit_is_active").checked,
      main_photo_url: editingPhotos[0],
      photo2_url: editingPhotos[1],
      photo3_url: editingPhotos[2],
      photo4_url: editingPhotos[3],
    };

    const { error } = await supabase
      .from("listing")
      .update(payload)
      .eq("id", editingListingId)
      .eq("owner_id", currentUser.id);

    if (error) {
      console.error("saveEditListing error", error);
      alert(error.message || "Failed to update listing.");
      return;
    }

    editingListingId = null;
    document.getElementById("editSection").classList.add("hidden");
    loadMyListings();
    setStatus("Listing updated.");
  }

  async function toggleListingActive(item) {
    const newValue = !(item.is_active !== false);
    const { error } = await supabase
      .from("listing")
      .update({ is_active: newValue })
      .eq("id", item.id)
      .eq("owner_id", currentUser.id);

    if (error) {
      console.error("toggleListingActive error", error);
      alert(error.message || "Failed to change status.");
      return;
    }

    loadMyListings();
  }

  async function deleteListing(item) {
    if (
      !confirm(
        "Delete this listing? Related messages may also be removed if cascade is enabled."
      )
    ) {
      return;
    }

    // Почистим фотки из Storage по возможности
    const urls = [
      item.main_photo_url,
      item.photo2_url,
      item.photo3_url,
      item.photo4_url,
    ].filter(Boolean);

    for (const url of urls) {
      try {
        await removePhotoFromStorage(url);
      } catch (e) {
        console.error("removePhotoFromStorage on delete error", e);
      }
    }

    const { error } = await supabase
      .from("listing")
      .delete()
      .eq("id", item.id)
      .eq("owner_id", currentUser.id);

    if (error) {
      console.error("deleteListing error", error);
      alert(error.message || "Failed to delete listing. Check foreign key cascades.");
      return;
    }

    loadMyListings();
    setStatus("Listing deleted.");
  }
</script>
</body>
</html>
